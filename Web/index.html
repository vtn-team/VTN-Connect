<html>
<head>
<link rel="manifest" href="/manifest.json" />
<link rel="apple-touch-icon" href="/icon.png"></link>
<meta name="theme-color" content="#fff" />
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0 user-scalable=no">
<title>VANTAN - CONNECT (DEV LOCATION)</title>
<link href="https://unpkg.com/nes.css/css/nes.css" rel="stylesheet" />
<script src="https://unpkg.com/html5-qrcode" type="text/javascript" ></script>
<script src="anime.min.js"></script>
<style>
/* ドット調のフォントに変更 */
@font-face {
  font-family: "PixelMplus12-Regular";
  src: 
    local("PixelMplus12-Regular"),
    url("https://www.vtn-game.com/vc/PixelMplus12-Regular.woff2") format("woff2"),
    url("https://www.vtn-game.com/vc/PixelMplus12-Regular.woff") format("woff"),
    url("https://www.vtn-game.com/vc/PixelMplus12-Regular.ttf");
}

html, body, pre, code, kbd, samp {
  font-family: "PixelMplus12-Regular", serif;
  overscroll-behavior: none;
}

body {
  overscroll-behavior-y: none;
}

pre {
  white-space: pre-wrap;
  word-break:break-all;
}

/* モーダル */
.modal {
  overscroll-behavior-y: none;
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100svh;
  background-color: rgba(0, 0, 0, 0.4);
  z-index: 1;
  overflow: hidden;
}

.modal-content {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 80%;
  height: 70svh;
  padding: 20px;
}

#cheer {
  /*width: 300px;*/
  /*height: 60px;*/
  background-color: #fefefe;
  border: 1px solid #888;
  border-radius: 10px;
}

#closeModal {
  position: absolute;
  display: flex;
  align-items: center;
  justify-content: center;
  top: 2%;
  right: 2%;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  color: #FFF;
  width: 40px;
  height: 40px;
  background-color: #333;
}

/* レイアウト */
.layout {
  width: 100%;
  height: 100%;
  
  background-image: url('https://www.vtn-game.com/vc/bg.jpg');
  background-size: auto 100lvh;
  background-repeat: no-repeat;
  background-attachment: fixed;
  
  overflow: hidden;
  overscroll-behavior-y: none;
}
.main-content {
  width: 300%;
  height: 300%;

  display: grid;
  grid-template-columns: repeat(3, 1fr);
  grid-auto-rows: 100svh;
  gap: 8px;
  
  position: relative;
  top: "-100%";
  left: "-100%";
}
.nav-menu {
  display: grid;
  grid-template-columns: repeat(3, 100px);
  grid-auto-rows: 100px;
  gap: 8px;
}

.menu-btn {
  width:100px;
  height:100px;
}

.checkbg {
  background-color: #00000000;
  background-image: linear-gradient(45deg, #aaa 25%, transparent 25%, transparent 75%, #aaa 75%),
                    linear-gradient(45deg, #aaa 25%, transparent 25%, transparent 75%, #aaa 75%);
  background-size: 4px 4px;
  background-position: 0 0, 2px 2px;
}

.main-block {
  width:100%;
  /*max-width: 640px;*/
  height:100%;
  overflow-y: scroll;
  overscroll-behavior-y: none;
}

.right-side {
  text-align: right;
}

.float-window {
  position: relative;
  top: -200px;
  z-index: 10;
}

.header {
  /*grid-area: header;*/
  position: sticky;
  top: 0px;
  display: flex;
  align-items: baseline;
  height: 50px;
  /* max-width: 375px; */
  /* margin: 0 auto; */
  padding-top: 1rem;
  transition: all 0.2s ease;
  z-index: 10;
}

.nes-header {
  position: relative;
  padding: 10px 0;
  width:100%;
  border-color: black;
  border-style: double none;
  border-width: 4px;
  text-align:center;
  background-color: #eeeeeeee
}

.video {
  width:375px;
  max-width: 375px;
  margin: 0 auto;
  background-color: #eeeeeeee
}

.status {
  width: 95%;
  margin: 0 auto;
  
  background-color: #eeeeeeee;
  
  /*
  background-image: linear-gradient(45deg, #eee 25%, transparent 25%, transparent 40%, #fff 55%),
                    linear-gradient(45deg, #eee 25%, transparent 25%, transparent 40%, #fff 55%);
  background-size: 2px 2px;
  background-position: 0 0, 1px 1px;
  */
}

/* 浮かせるヘッダ */
header.nav {
  font-size: 0.8rem;
  padding: 0;
  align-items: center;
}

header.nav h1 {
  margin: 0;
}

header.nav p {
  display: none;
  margin-bottom: 0;
  font-size: 0.6rem;
}

.playerName { font-size: 1.5rem; }
.playerLevel { font-size: 1.2rem; }
.playerLevelGauge { height: 20px; border-width: 1px; }
.ask-text { width: 240px; height: 120px; }
.important { grid-area: important; }
.main { grid-area: main; margin: 0 auto; overflow:hidden; width:100%; height:100%; }
.menubtn { height: 360px; position: relative; top: -100px; grid-area: menubtn; }
.debugitem { grid-area: debugitem; }
.eventtest { grid-area: eventtest; }
.footer { grid-area: footer; }
.sidebar {  }
.long { height: 800px; }
.center { text-align:center; margin: 0 auto; }
.right { text-align:right; margin: 0 0 0 auto; }
.face { border-radius: 10px; width: 80px; height: 80px; border: solid 2px #000; background-color: #eee; }
.faceicon { float: right; width: 80px; height: 100px; }
.chatmsg { float: left; width: 200px; }
.nameplate { top:-25px; left:-8px; }
.log { max-height:70svh; }
.scrollLog { max-height:50svh; overflow-y: scroll; }

#reader { 
  display:none;
  width: 90%;
}
#userinfo {
  display:none;
}
#qrresult { 
  display:none;
}
#qrscancancel{ 
  display:none;
}
.leftmenu {
  width: 640px;
  max-width: 640px;
  margin: 20 20 auto;
  background-color: #eeeeeeee
}
</style>
<script type="text/javascript">

const CMD = {
	WELCOME: 1,
	JOIN: 2,
	EVENT: 3,
	GAMESTAT: 4,
	CHEER: 5,
	USERSTAT: 6,
	SEND_JOIN: 100,
	SEND_EVENT: 101,
	SEND_EPISODE: 102,
	SEND_CHEER: 103,
	SEND_QR: 104,
	SEND_USER_JOIN: 110,
	ERROR: 500,
};

const PAGE = {
	LAUNCH: 0,
	HELLO_WORLD: 1,
	USER_CREATE: 2,
	MAIN_MENU: 3,
};

const EFFECT = {
	SUMMON: 0,
	ASK_SEND: 1,
};

/*
・そもそもバンコネとは…
・QR読んでね
・ゲームリンクと冒険
・他の人応援しようね、良いことあるよ
・連動イベントがあるよ
・冒険(AIゲーム)について
*/
const TUTORIAL = {
	HELLO: 0,
	FIRST_QR: 1,
	QR: 2,
	GAMELINK: 3,
	GAMEASK: 4,
	END: 5,
}

const CONTENTS = {
	MAIN_MENU: 1,
	USER_PROFILE: 2,
	GAME_HISTORY: 3,
	GAME_ASK: 4,
	HOWTOPLAY: 5,
	QR_SEARCH: 6,
	FRIEND_LIST: 7,
	PUBLISHING: 8,
	CREDIT: 9
}

const movieList = [
	"HQ40hkN-n10",
	"TCWxWSPTKNk",
	"d3ung6yfn6w",
	"fiwx5iWPG5I",
	"Fk2YpPMcSfA",
	"srVAI-M0i_c",
	"5Q77hzBjtFU",
	"koyxhykV3bo",
	"fjt6bEuDQU4",
	"XFcWZaUxXVs",
	"WVQ7l9VP1L4",
];


let userData = {};
let saveData = null;
let gameInfo = {};
let levelMaster = {};
let elementCache = [];
let elementStatus = [];

let effectCache = [];
let tutorialCache = [];
let currentPageCode = -1;
let currentContentCode = -1;
let callNo = 0;
let eventQueue = [];

let ws = null;
let wsSessionId = "";

let qrReader = null;
let baseURI = "https://vc.vtn-game.com";
let resourceURI = "https://www.vtn-game.com";
let wssURI = "wss://wss.vtn-game.com/ws/";

window.addEventListener("load", async (event) => {
	console.log("onload event");
	
	//localhostの場合挙動を変える
	if(document.location.hostname == "localhost") {
		baseURI = "http://localhost:4649";
	}
	
	//最終的に埋め込む
	gameInfo = await getMaster("GameInfo");
	let lm = await getMaster("Level");
	for(let m of lm) {
		levelMaster[m.Level] = m;
	}
	
	//セーブデータ取得
	loadSaveData();
	
	//Youtubeのリンクを生成
	embedYoutubeLink();
	
	//animating wallpaper
	var tl = anime.timeline({
		targets: "body",
		direction: 'alternate', // Is not inherited
		easing: 'easeInOutCubic',
		loop: true
	});
	tl.add({
		backgroundPositionX: 100,
		duration: 100000
	})
	.add({
		backgroundPositionX: 0,
		duration: 100000,
	})
	
	//ページコンテンツの分解
	setupSPA();
	
	//PCの場合デバッグメニューだす
	if(document.location.hostname.indexOf("www.vtn-game.com") == -1 && !isSmartPhone()) {
		enableUIById("debugitem");
		setupDebugMenu();
		
		//localhostだけ
		if(document.location.hostname.indexOf("localhost") != -1) {
			wssURI = "ws://127.01.0.1:3746";//await getaddr();
		}
	}
	
	//debug
	if(0){
		summonEffect();
		userCreateNextPageCheck(1);
		return;
	}
	
	console.log(saveData);
	
	firstView();
	
	if(!isRunningAsPWA()) {
		//TBD: 警告出す
	}
});

async function firstView() {
	if(!saveData.user_hash || saveData.user_hash === "undefined") {
		//初回登録
		loadPage(PAGE.HELLO_WORLD);
	}else{
		//ログイン
		await loadUser(saveData.user_hash);
		if(userData) {
			userSetup();
			loadContent(CONTENTS.MAIN_MENU);
			loadPage(PAGE.MAIN_MENU);
		}else{
			firstView();
		}
	}
}

function backToMain() {
	loadPage(PAGE.MAIN_MENU);
}


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// API 
//////////

//接続先取得
async function getaddr() {
	let req = await fetch(`${baseURI}/vc/getaddr`, {
		mode: 'cors'
	});
	let result = await req.json();
	return result.Address;
}

//マスタ取得
async function getMaster(name) {
	let req = await fetch(`${baseURI}/tools/getmaster/${name}`, {
		mode: 'cors'
	});
	let result = await req.json();
	return result.Master;
}

//ユーザ読み込み
async function loadUser(userHash) {
	let user = null; //localStorage.getItem("UserData");
	/*
	if(user) {
		try{
			user = JSON.parse(user);
		}catch(ex){
		}
	}
	*/
	
	if(user && user.UserHash) {
		userData = user;
	}else{
		let req = await fetch(`${baseURI}/vc/user/${userHash}`, {
			mode: 'cors'
		});
		let result = await req.json();
		
		userData = result.UserData;
		if(userData) {
			localStorage.setItem("UserData", JSON.stringify(userData));
		}else{
			saveData.user_hash = "undefined";
		}
	}
}

//ユーザ作成
async function createUser(data) {
	let req = await fetch(`${baseURI}/vc/usercreate`, {
		method: 'POST',
		mode: 'cors',
		body: JSON.stringify(data)
	});
	
	let result = await req.json();
	if(result.Success) {
		userData = result.UserData;
		localStorage.setItem("UserData", JSON.stringify(userData));
		saveSessionData();
	}
}

//ユーザアンケート
async function userGameAsk(data) {
	let req = await fetch(`${baseURI}/vc/gameask`, {
		method: 'POST',
		mode: 'cors',
		body: JSON.stringify(data)
	});
	
	let result = await req.json();
	return result;
}

//ウラコマンド、AIゲーム開始
let aiGameState = {};
async function dontUseAIGameStart() {
	let req = await fetch(`${baseURI}/vc/ai/gamestart/${name}`, {
		method: 'POST',
		mode: 'cors',
		body: JSON.stringify({ Option: 0 })
	});
	let result = await req.json();
	aiGameState = result;
	console.log(result);
	return result.Master;
}
//ウラコマンド、AIゲーム終了
async function dontUseAIGameEnd() {
	let rnd1 = (Math.random() < 0.5);
	let rnd2 = (Math.random() < 0.5);
	
	let gameData = [];
	for(let u of aiGameState.GameUsers) {
		gameData.push({
			UserId: u.UserId,
			GameResult: rnd1,
			MissionClear: rnd2
		});
	}
	
	let req = await fetch(`${baseURI}/vc/ai/gameend/${name}`, {
		method: 'POST',
		mode: 'cors',
		body: JSON.stringify({
			GameHash: aiGameState.GameHash,
			UserResults: gameData
		})
	});
	
	delete aiGameState;
	
	let result = await req.json();
	console.log(result);
	return result.Master;
}

function userSetup() {
	if(!userData) return ;
	
	createUserInfoUI();
	enableUIById("userinfo");
	
	getElm("dbgUserId").innerText = userData.UserId;
	getElm("dbgAvatarType").innerText = userData.AvatarType;
	
	let userLevel = getUserLevel(userData.Exp);
	getElm("playerName").innerText = userData.Name;
	getElm("playerLevel").innerText = "レベル:" + userLevel.Level;
	getElm("playerNextExp").innerText = userLevel.Next;
	getElm("nextlv").value = userLevel.ExpGauge;
	getElm("playerGold").innerText = userData.Gold;
	
	connectDGS();
}


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// EVENT 
//////////
//WebSocket接続
function connectDGS() {
	ws = new WebSocket(wssURI);
	
	ws.onopen = (event) => {
	};
	
	ws.onerror = (error) => {
		console.log("Connection Error");
		console.log(error)
		getElm("ws-state").innerText = "エラー";
		
		//再接続する
		setTimeout(()=>{ connectDGS(); }, 5000);
	};
		
	ws.onclose = (event) => {
		console.log("close");
		getElm("ws-state").innerText = "切断";
		
		//再接続する
		setTimeout(()=>{ connectDGS(); }, 5000);
	};

	ws.onmessage = (event) => {
		const json = JSON.parse(event.data);
		const time = new Date(json.date);
		//場合に応じて
		let data = JSON.parse(json.Data);
		json.Data = data;
		execMessage(json);
	};
}

function execMessage(data) {
	let ret = "";
	let payload = parsePayload(data.Data.Payload);
	delete data.Data.Payload;
	data.Data.Payload = payload;
	
	switch(data.Command){
	case CMD.WELCOME:
	{
		//SessionIdをキーにしてJoinを返す
		let json = {
			SessionId: data.Data.SessionId,
			Command: CMD.SEND_USER_JOIN,
			UserId: userData.UserId,
		};
		ws.send(JSON.stringify(json));
		wsSessionId = data.Data.SessionId;
		getElm("ws-state").innerText = "接続";
	}
	break;
	
	case CMD.USERSTAT:
		console.log(data);
		{
			let update = data.Data.UpdateStat;
			let userLevel = getUserLevel(update.Exp);
			getElm("playerLevel").innerText = "レベル:" + userLevel.Level;
			getElm("playerNextExp").innerText = userLevel.Next;
			getElm("nextlv").value = userLevel.ExpGauge;
			getElm("playerGold").innerText = update.Gold;
		}
		break;
	
	case CMD.GAMESTAT:
		activeGameInfo = data.Data.ActiveGames;
		console.log(activeGameInfo);
		updateGameStat(data.Data);
		break;
	
	case CMD.EVENT:
	{
		console.log(payload);
		
		getElm("errorMessage").innerHTML = JSON.stringify(payload);
		
		//addSysLog("冒険者が魔法を使った", data.Data.Data);
		switch(data.Data.EventId)
		{
		case 100:
		{
		}
		break;
		
		case 1000:
		{
			addSysLog(data.Data.Data.Name, data.Data.Data.Message);
		}
		break;
		
		case 1001:
		{
			addLog(data.Data);
		}
		break;
		
		case 1002:
		{
			addSysLog(data.Data.Data.Name, data.Data.Data.Message);
		}
		break;
		}
	}
	break;
	
	case CMD.ERROR:
	{
		setupErrorDialog(data);
	}
	break;
	
	}
	return ret;
}

function setupErrorDialog(data) {
	enableUIById("modal-error");
	
	getElm("errorMessage").innerHTML = data.Message;
	console.log(data)
}

function closeError() {
	getElm("errorMessage").innerHTML = "";
	disableUIById("modal-error");
}

let cheerTarget = null;
function cheerSetup(tgtGameId, toUserId) {
	let playingUserName = "";
	for(let game of activeGameInfo) {
		if(game.GameId == tgtGameId) {
			console.log(game)
			if(game.GameId == 1) { 
				for(let u of game.Session.GameUsers) {
					if(u.UserId == toUserId) {
						playingUserName = u.Name;
						break;
					}
				}
			}else{
				playingUserName = game.Session.UserInfo.Name;
			}
		}
	}
	cheerTarget = {
		ToUserId: toUserId,
		TgtGameId: tgtGameId
	};
	
	enableUIById("modal-cheer");
	getElm("cheerUserName").innerHTML = playingUserName;
}

function closeCheer() {
	getElm("cheerMessage").value = "";
	disableUIById("modal-cheer");
	cheerTarget=null;
}

function sendCheerMessage() {
	if(!cheerTarget) return;
	let msg = getElm("cheerMessage").value;
	cheerMessage(cheerTarget.ToUserId, cheerTarget.TgtGameId, msg, 0);
	
	closeCheer();
}

function cheerMessage(toUserId, tgtGameId, msg, emo) {
	let fromUserId = -1;
	if(userData.UserId) {
		fromUserId = userData.UserId;
	}
	let name = "nanashi";
	if(userData.DisplayName) {
		name = userData.DisplayName;
	}
	
	//SessionIdをキーにしてJoinを返す
	let data = {
		Avatar: userData.AvatarType,
		Name: name,
		Message: msg,
	};
	
	if(emo) {
		data.Emotion = emo;
	}
	
	let json = {
		SessionId: wsSessionId,
		Command: CMD.SEND_CHEER,
		GameId: tgtGameId,
		ToUserId: toUserId,
		FromUserId: fromUserId,
		Data: data
	};
	console.log(json)
	ws.send(JSON.stringify(json));
}

function sendQREvent(code, isDebug) {
	try{
		//SessionIdをキーにしてJoinを返す
		let json = {
			SessionId: wsSessionId,
			Command: CMD.SEND_QR,
			SerialCode: code,
			UserId: userData.UserId,
			IsDebug: isDebug
		};
		ws.send(JSON.stringify(json));
	}catch(ex){
		console.log(ex);
	}
}


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// HTML生成回り 
//////////

function setupSPA() {
	elementCache.push(getElm("page-launch"));
	elementCache.push(getElm("page-hello-world"));
	elementCache.push(getElm("page-user-create"));
	elementCache.push(getElm("page-main"));
	
	tutorialCache.push(getElm("page-tutorial-hello"));
	tutorialCache.push(getElm("page-tutorial-hello"));
	tutorialCache.push(getElm("page-tutorial-qr"));
	tutorialCache.push(getElm("page-tutorial-gamelink"));
	tutorialCache.push(getElm("page-tutorial-gameask"));
	
	effectCache.push(getElm("summon-effect"));
	effectCache.push(getElm("ask-send-effect"));
	
	/*
	elementCache.push(getElm("page-user-profile"));
	elementCache.push(getElm("page-game-history"));
	elementCache.push(getElm("page-game-ask"));
	elementCache.push(getElm("page-game-view"));
	elementCache.push(getElm("page-qr-search"));
	elementCache.push(getElm("page-friend-list"));
	elementCache.push(getElm("page-credit"));
	elementCache.push(getElm("page-tutorial-pwa"));
	*/
	
	//tutorial
	for(let i=0; i<tutorialCache.length; ++i) {
		if(isTutorialNow(i)) {
			tutorialCache[i].style.display = "none";
		}
	}
	
	//effect
	for(let i=0; i<effectCache.length; ++i) {
		effectCache[i].style.display = "none";
	}
	anime({
		targets: '.main-content',
		top: '-100%',
		left: '-100%',
		duration: 0
	});
	
	for(let i=0; i < elementCache.length; ++i) {
		elementCache[i].style.display = "none";
		elementStatus.push(0);
	}
	
	elementStatus[0] = 1;
	
	getElm("usercreate").addEventListener('click', async () => {
		let data = {
			Name: getElm("username").value,
			Questions: [
				getElm("question1").value,
				getElm("question2").value,
				getElm("question3").value,
				getElm("question4").value,
			]
		};
		console.log(data);
		
		summonEffect();
		await createUser(data);
		userCreateNextPageCheck(1);
	});
	
	let elm = getElm("game-ask-0");
	for(let game of gameInfo) {
		if(game.Id >= 6 && game.Id <= 8) continue; //チェンガ対策
		if(game.Id >= 99) continue;
		var option = document.createElement("option");
		option.text = game.GameTitle;
		option.value = game.Id;
		elm.appendChild(option);
	}
	
	getElm("game-ask-send").addEventListener('click', async () => {
		let askOk = true;
		for(let i=0; i<8; ++i){
			if(getElm("game-ask-"+i).value == "0"){
				setupErrorDialog({ Message: "項目を入力してください" });
				askOk = false;
				break;
			}
		}
		if(!askOk) return;
		
		let data = {
			UserId: userData.UserId,
			GameId: getElm("game-ask-0").value,
			GameTitle: getElm("game-ask-0").selectedOptions[0].text,
			Gender: getElm("game-ask-1").selectedOptions[0].text,
			Age: getElm("game-ask-2").selectedOptions[0].text,
			Originality: getElm("game-ask-3").selectedOptions[0].text,
			Funny: getElm("game-ask-4").selectedOptions[0].text,
			Quality: getElm("game-ask-5").selectedOptions[0].text,
			Rule: getElm("game-ask-6").selectedOptions[0].text,
			Replay: getElm("game-ask-7").selectedOptions[0].text,
			Speciality: getElm("game-ask-8").value,
			Improvement: getElm("game-ask-9").value,
		};
		console.log(data);
		sendAskEffect();
		let result = await userGameAsk(data);
		console.log(result);
	});
}

function closePage(pageCode) {
	if(!elementCache[pageCode]) return ;
	elementCache[pageCode].style.display = "none";
}

function loadPage(pageCode) {
	console.log(currentPageCode + "/" + pageCode);
	if(currentPageCode == pageCode) return;
	
	for(let i=0; i < elementStatus.length; ++i) {
		if(elementStatus[i]) {
			elementCache[i].style.display = "none";
			elementStatus[i] = 0;
		}
	}
	
	elementCache[pageCode].style.display = "block";
	elementStatus[pageCode] = 1;
	
	currentPageCode = pageCode;
	console.log(pageCode);
}

function closeEffect(effectCode) {
	if(!effectCache[effectCode]) return ;
	effectCache[effectCode].style.display = "none";
}

function loadEffect(effectCode) {
	effectCache[effectCode].style.display = "block";
}

function loadContent(contentCode) {
	if(currentContentCode == contentCode) return;
	
	currentContentCode = contentCode;
	
	for(let i=1; i<=9; ++i) {
		if(i == 4) continue;
		var elm = getElm("menu-btn-"+i);
		elm.classList.add("is-primary");
	}
	{
		var elm = getElm("menu-btn-4");
		elm.classList.add("is-success");
	}
	
	console.log(contentCode);
	
	//スクロール
	switch(contentCode) {
	case CONTENTS.GAME_ASK:
		anime({
			targets: ".main-content",
			top: "0%",
			left: "-100%",
			easing: 'easeInOutQuart',
			duration: 500
		});
		{
			var elm = getElm("menu-btn-4");
			elm.classList.remove("is-primary");
		}
		break;
		
	case CONTENTS.FRIEND_LIST:
		anime({
			targets: ".main-content",
			top: "0%",
			left: "-200%",
			easing: 'easeInOutQuart',
			duration: 500
		});
		{
			var elm = getElm("menu-btn-6");
			elm.classList.remove("is-primary");
		}
		break;
		
	case CONTENTS.HOWTOPLAY:
		anime({
			targets: ".main-content",
			top: "-100%",
			left: "0%",
			easing: 'easeInOutQuart',
			duration: 500
		});
		{
			var elm = getElm("menu-btn-2");
			elm.classList.remove("is-primary");
		}
		break;
		
	case CONTENTS.MAIN_MENU:
		anime({
			targets: ".main-content",
			top: "-100%",
			left: "-100%",
			easing: 'easeInOutQuart',
			duration: 500
		});
		{
			var elm = getElm("mainmenu");
			elm.style.display = "block";
			
			var elm = getElm("menu-btn-1");
			elm.classList.remove("is-primary");
		}
		break;
		
	case CONTENTS.QR_SEARCH:
		anime({
			targets: ".main-content",
			top: "-100%",
			left: "-200%",
			easing: 'easeInOutQuart',
			duration: 500
		});
		{
			var elm = getElm("menu-btn-3");
			elm.classList.remove("is-primary");
		}
		break;
		
	case CONTENTS.GAME_HISTORY:
		anime({
			targets: ".main-content",
			top: "-200%",
			left: "0%",
			easing: 'easeInOutQuart',
			duration: 500
		});
		{
			var elm = getElm("menu-btn-8");
			elm.classList.remove("is-primary");
		}
		break;
		
	case CONTENTS.USER_PROFILE:
		anime({
			targets: ".main-content",
			top: "-200%",
			left: "-100%",
			easing: 'easeInOutQuart',
			duration: 500
		});
		{
			var elm = getElm("menu-btn-7");
			elm.classList.remove("is-primary");
		}
		break;
		
	case CONTENTS.CREDIT:
		anime({
			targets: ".main-content",
			top: "-200%",
			left: "-200%",
			easing: 'easeInOutQuart',
			duration: 500
		});
		{
			var elm = getElm("menu-btn-9");
			elm.classList.remove("is-primary");
		}
		break;
		
	case CONTENTS.PUBLISHING:
		anime({
			targets: ".main-content",
			top: "0%",
			left: "0%",
			easing: 'easeInOutQuart',
			duration: 500
		});
		{
			var elm = getElm("menu-btn-5");
			elm.classList.remove("is-primary");
		}
		break;
	}
	
	//移動に合わせて消す
	closeMenu();
}

//プロフィール
function showProfile(userId = 0) {
	if(currentContentCode == CONTENTS.USER_PROFILE) return;
	
	if(userId == 0) {
		userId = userData.UserId;
	}
	
	openUserProfile(userId);
}

//QR探索
function openQRSearch() {
	if(currentContentCode == CONTENTS.QR_SEARCH) return;
	
	readQR();
	loadContent(CONTENTS.QR_SEARCH);
}

//フレンド
function showFriends() {
	if(currentContentCode == CONTENTS.FRIEND_LIST) return;
	
	openFriendList();
}

//アンケート
function showGameAsk(gameId=0) {
	if(currentContentCode == CONTENTS.GAME_ASK) return;
	
	loadContent(CONTENTS.GAME_ASK);
}

//
function showGameHistory(gameId = 0) {
	if(currentContentCode == CONTENTS.GAME_HISTORY) return;
	
	openGameHistory(gameId);
}

async function readHistory(title, gameHash, logId) {
	let req = await fetch(`${resourceURI}/vc/log/${logId}`, {
		mode: 'cors'
	});
	
	let result = await req.json();
	
	var elm = getElm("adventureLogMsg");
	elm.innerHTML = result.StoryBook.replaceAll("\n", "<br />");
	
	var elm = getElm("adventureLogTitle");
	elm.innerHTML = title;
	
	enableUIById("modal-adventure-log");
}

async function openGameHistory(gameId) {
	let req = await fetch(`${baseURI}/vc/games/${gameId}`, {
		mode: 'cors'
	});
	let result = await req.json();
	console.log(result);
	
	createGameHistory(result.History, result.Count);
	loadContent(CONTENTS.GAME_HISTORY);
}

async function openReward(title, rewards) {
	var elm = getElm("rewardLogMsg");
	elm.innerHTML = "";
	//result.StoryBook.replaceAll("\n", "<br />");
	
	var elm = getElm("rewardLogTitle");
	elm.innerHTML = title;
	
	enableUIById("modal-reward-log");
}

async function openFriendList() {
	let req = await fetch(`${baseURI}/vc/friend/${userData.UserId}`, {
		mode: 'cors'
	});
	
	let result = await req.json();
	console.log(result);
	
	createFrienedList(result.Friends.Friends, result.Friends.Count);
	loadContent(CONTENTS.FRIEND_LIST);
}

function closeHistory() {
	disableUIById("modal-adventure-log");
}

function closeRewardLog() {
	disableUIById("modal-reward-log");
}

function createUserAdventureHistory(history, maxCount) {
	var elm = getElm("history");
	let html = "";
	
	for(let i=0; i<history.length; ++i) {
		html += `
					<section class="history" style="height:120px;">
						${history[i].Title}<br /><button type="button" class="nes-btn is-primary" onclick="readHistory('${history[i].Title}', '${history[i].GameHash}', '${history[i].LogId}')">読む</button>
					</section>`;//
	}
	
	if(history.length == 0) {
		html += `
					<section class="history" style="height:120px;">
						冒険はまだない
					</section>`;
	}else{
		html += `
					<section class="history" style="height:120px;">
						<button type="button" class="nes-btn is-primary">もっと見る</button>
					</section>`;
	}
	
	elm.innerHTML = html;
}

function createGameHistory(history, maxCount) {
	var elm = getElm("gameHistory");
	let html = "";
	
	let group_by = {};
	for(let i=0; i<history.length; ++i) {
		if(!group_by[history[i].GameHash]) {
			group_by[history[i].GameHash] = [];
		}
		group_by[history[i].GameHash].push(history[i])
	}
	
	for(let gameHash in group_by) {
		if(group_by[gameHash].length == 1) {
			html += `<<${group_by[gameHash][0].Title}>><br />`;
			html += `<section class="history" style="height:80px;">`;
			html += `${group_by[gameHash][0].PlayerName}の冒険　<button type="button" class="nes-btn is-primary readbutton" onclick="readHistory('${group_by[gameHash][0].Title}', '${group_by[gameHash][0].GameHash}', '${group_by[gameHash][0].LogId}')">読む</button>`;
		}else{
			html += `<<${group_by[gameHash][0].Title}>><br />`;
			html += `<section class="history" style="height:240px;">`;
			for(let i=0; i<group_by[gameHash].length; ++i) {
				html += `　　${group_by[gameHash][i].PlayerName}の冒険　<button type="button" class="nes-btn is-primary" onclick="readHistory('${group_by[gameHash][i].Title}', '${group_by[gameHash][i].GameHash}', '${group_by[gameHash][i].LogId}')">読む</button><br />`;
			}
		}
		html += "</section>";
	}
	
	if(history.length == 0) {
		html += `
					<section class="history" style="height:120px;">
						冒険はまだない
					</section>`;
	}else{
		html += `
					<section class="history" style="height:120px;">
						<button type="button" class="nes-btn is-primary">もっと見る</button>
					</section>`;
	}
	
	elm.innerHTML = html;
}

function createFrienedList(friends, maxCount) {
	var elm = getElm("friendList");
	let html = "";
	
	for(let i=0; i<friends.length; ++i) {
		html += `<section class="friend" style="height:100px;">`;
		switch(friends[i].EventId) {
		case 200:
			html += `${friends[i].FriendName}とダンジョン内で${friends[i].EnCount}回交流した！<br /><div class="right-side"><button type="button" class="nes-btn is-primary readbutton" onclick="showFriendProfile('${friends[i].FriendId}')">プロフィール</button></div>`;
			break;
			
		case 1001:
			html += `${friends[i].FriendName}から${friends[i].EnCount}回応援された！<br /><div class="right-side"><button type="button" class="nes-btn is-primary readbutton" onclick="showFriendProfile('${friends[i].FriendId}')">プロフィール</button></div>`;
			break;
		}
		html += "</section>";
	}
	
	if(history.length == 0) {
		html += `
					<section class="history" style="height:120px;">
						交流はまだない
					</section>`;
	}else if(maxCount > 25){
		html += `
					<section class="history" style="height:120px;">
						<button type="button" class="nes-btn is-primary">もっと見る</button>
					</section>`;
	}
	
	elm.innerHTML = html;
}

function createUserMessageLog(message, maxCount) {
	
}

function getUserLevel(exp) {
	let ret = 1;
	let next = 0;
	let rate = 0;
	for(let lv = 1; lv < 50; ++lv) {
		let level = levelMaster[lv];
		exp -= level.NeedExp;
		if(exp < 0) {
			ret = lv-1;
			next = (-exp);
			rate = Math.floor(next / level.NeedExp * 100);
			break;
		}
	}
	return {
		Level: ret,
		Next: next,
		ExpGauge: rate
	}
}

async function openUserProfile(userId) {
	let req = await fetch(`${baseURI}/vc/user/${userId}?withLog=1&withMessage=1`, {
		mode: 'cors'
	});
	let result = await req.json();
	let ud = result.UserData;
	console.log(ud);
	
	createUserInfoUI(ud);
	createUserAdventureHistory(ud.History, ud.HistoryCount);
	createUserMessageLog(ud.Message, ud.MessageCount);
	
	loadContent(CONTENTS.USER_PROFILE);
}

function summonEffect() {
	//closePage(PAGE.USER_CREATE);
	loadEffect(EFFECT.SUMMON);
	
	anime({
		targets: getElm("summongauge"),
		value: [0, 150],
		easing: 'easeInOutQuart',
			round: 1,
			duration: 10000,
			easing: 'easeInOutExpo'
	});
	
	setTimeout(() => {
		userCreateNextPageCheck(2);
	}, 7500);
}

function sendAskEffect() {
	loadEffect(EFFECT.ASK_SEND);
	
	anime({
		targets: getElm("askgauge"),
		value: [0, 100],
		easing: 'easeInOutQuart',
			round: 1,
			duration: 3000,
			easing: 'easeInOutExpo'
	});
	
	setTimeout(() => {
		firstView();
	}, 3500);
}

function userCreateNextPageCheck(no) {
	console.log("no:" + no)
	callNo += no;
	if(callNo >= 3) {
		userSetup();
		loadPage(PAGE.MAIN_MENU);
	}
}

function nextTutorial() {
	loadPage(PAGE.USER_CREATE);
}

/*
function tutorialView() {
	switch(tutorialStep) {
	case 0:
		loadPage(PAGE.HELLO_WORLD);
		break;
		
	case 1:
		loadPage(PAGE.USER_CREATE);
		break;
	}
}

function flagTutorial() {
	console.log("tutorialStep" + tutorialStep)
	switch(tutorialStep) {
	case 0:
		tutorialStep = 1;
		break;
		
	case 1:
		tutorialStep = 2;
		break;
	}
	
	tutorialView();
}

function pwaSkip() {
	tutorialStep |= 1;
	tutorialView();
}
*/

let youtubeIndex = 0;
function embedYoutubeLink() {
	var tag = document.createElement('script');
	tag.src = "https://www.youtube.com/iframe_api";
	var firstScriptTag = document.getElementsByTagName('script')[0];
	firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

	var elm = getElm("youtubeLive");
	elm.innerHTML = `<div id="ytPlayer"></div>`;
	//elm.innerHTML += `<div class="nes-container is-rounded with-title video"><p class="title">配信中</p><iframe width="320" height="178" src="${link}&autoplay=1&mute=1" title="Vantan Game Contents" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe></div>`;
}

// 3. This function creates an <iframe> (and YouTube player)
//    after the API code downloads.
var ytPlayer;
function onYouTubeIframeAPIReady() {
	let link = movieList[youtubeIndex];
	youtubeIndex++;
	if(youtubeIndex >= movieList.length) {
		youtubeIndex = 0;
	}
	
	ytPlayer = new YT.Player('ytPlayer', {
		height: '178',
		width: '320',
		playerVars: { 'autoplay': 0, 'controls': 0 },
		videoId: link,
		events: {
			'onStateChange': onPlayerStateChange
		}
	});
}

function playNextVideo() {
	console.log("next video");
	let link = movieList[youtubeIndex];
	youtubeIndex++;
	if(youtubeIndex >= movieList.length) {
		youtubeIndex = 0;
	}
	
	ytPlayer.loadVideoById(link);
}

var done = false;
function onPlayerStateChange(event) {
	ytPlayer = event.target;
	console.log("here:" + ytPlayer.getPlayerState());
	if(ytPlayer.getPlayerState() == 0) {
		setTimeout(() => {
			playNextVideo();
		}, 100);
	}
}

function addSysLog(evtName, evtMessage) {
	var log=`
					<section style="height:120px;">
						<div class="nes-container is-rounded with-title" style="height:80px;">
						<p class="title">${evtName}</p>
						<p style="overflow: hidden;text-overflow: ellipsis;">${evtMessage}</p>
						</div>
					</section>
`;
	var elm = getElm("msglog");
	elm.innerHTML += log;
	while(elm.children.length > 10)
	{
		elm.children[0].remove();
	}
}

function addLog(evtData) {
	let isSelf = userData.UserId == evtData.UserId

	let name = evtData.Payload.Name;
	let text = evtData.Payload.Message;
	let emo = evtData.Payload.Emotion;

	var left=`
					<section class="message -left" style="height:120px;">
						<div style="display:flex;">
							<div class="faceicon">
								<div class="face">${emo}</div>
								<div class="nes-badge nameplate" style="width:80px;">
									<span class="is-dark">${name}</span>
								</div>
							</div>
							<div class="nes-balloon from-left chatmsg" style="height:70px;top:-10px;padding: 5px;">
								<p style="width: 180px;height:60px;overflow: hidden;text-overflow: ellipsis;">${text}</p>
							</div>
						</div>
					</section>
`;
	var right=`
					<section class="message -right" style="height:120px;">
						<div style="display:flex;">
							<div class="nes-balloon from-right chatmsg" style="height:70px;top:-10px;padding: 5px;">
								<p style="width: 180px;height:60px;overflow: hidden;text-overflow: ellipsis;">${text}</p>
							</div>
							<div class="faceicon">
								<div class="face">${emo}</div>
								<div class="nes-badge nameplate" style="width:80px;">
									<span class="is-dark">${name}</span>
								</div>
							</div>
						</div>
					</section>
`;
	var elm = getElm("msglog");
	elm.innerHTML += isSelf ? right : left;
	while(elm.children.length > 10)
	{
		elm.children[0].remove();
	}
}


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// QR 
//////////

async function readQR() {
	disableUIById("qrscan");
	disableUIById("qrscancancel");
	enableUIById("qrscancancel");
	enableUIById("reader");
	
	
	let devices = await Html5Qrcode.getCameras();
	console.log(devices)
	
	let cameraId = devices[0].id;
	if(devices[1]) {
		cameraId = devices[1].id;
	}
	
	qrReader = new Html5Qrcode("reader");
	qrReader.start(
		cameraId, 
	{
		fps: 10,	// Optional, frame per seconds for qr code scanning
		qrbox: { width: 375, height: 375 }  // Optional, if you want bounded box UI
	},
	onScanSuccess,
	(errorMessage) => {
		// parse error, ignore it.
		console.log(errorMessage)
	})
	.catch((err) => {
		// Start failed, handle it.
		console.log(err)
	});
}

async function cencelQR() {
	disableUIById("qrscancancel");
	disableUIById("qrresult");
	enableUIById("qrscan");
	
	if(!qrReader) return;
	await qrReader.stop();
	
	disableUIById("reader");
}

async function onScanSuccess(decodedText, decodedResult) {
    // Handle on success condition with the decoded text or result.
	enableUIById("qrresult");
	await qrReader.stop();
	
	if(!userData || !userData.UserId)
	{
		getElm("qrresult").innerText = "ユーザー登録されていません";
		return;
	}
	
	if(decodedText.indexOf("VCQR:") == -1) {
		getElm("qrresult").innerText = "無効なQRです";
		return;
	}
	
	//URLをパースしてシリアルコードだけ引き出す
	let qrSerialCode = decodedText.replace("VCQR:","");
	
	sendQREvent(qrSerialCode);
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// SYSTEM 
//////////

function isRunningAsPWA() {
	// 1. Android Chrome などが対応している `display-mode` 判定
	if (
		window.matchMedia &&
		window.matchMedia('(display-mode: standalone)').matches
	) {
		return true;
	}

	// 2. iOS Safari (ホーム画面追加されたWebApp) が提供する `navigator.standalone`
	if (window.navigator.standalone) {
		return true;
	}

	return false;
}

function getOSName() {
	const ua = navigator.userAgent.toLowerCase();
	if(ua.indexOf('android') > -1) {
		return "Android";
	}
	if(/iphone|ipad|ipod/.test(ua)) {
		return "iOS";
	}
	return "PC";
}

// 連想配列に格納
function getCookieArray() {
    var arr = {};
    if(document.cookie != ''){
        var tmp = document.cookie.split('; ');
        for(var i=0;i<tmp.length;i++){
            var data = tmp[i].split('=');
            arr[data[0]] = decodeURIComponent(data[1]);
        }
    }
    return arr;
}

//クッキーにユーザハッシュを保存
function saveUserSession() {
	var limit = 7; //Cookieの期限
	var now = new Date();
	now.setTime(now.getTime() + limit*24*60*60*1000);
	var expireDate = now.toGMTString();
	
	var cookievalue = "user_hash=" + userData.UserHash;
	var expires = "expires=" + expireDate + "; ";
	var path = "path=/";
	
	document.cookie = cookievalue + expires + path;
}

function isSmartPhone() {
	if (window.matchMedia && window.matchMedia('(max-device-width: 640px)').matches) {
		return true;
	} else {
		return false;
	}
}

function loadSaveData() {
	let save = localStorage.getItem("SaveData");
	if(save) {
		try{
			saveData = JSON.parse(save);
		}catch(ex){
		}
	}
	if(saveData) return;
	
	//クッキー取得
	saveData = getCookieArray();
	
	if(saveData) return;
	
	saveData = {
		tutorial : 0,
		tutorialFlag : {}
	};
}

function saveSessionData() {
	saveData.user_hash = userData.UserHash;
	localStorage.setItem("SaveData", JSON.stringify(saveData));
	saveUserSession(userData.UserHash);
}

function getElm(elmId) {
	return document.getElementById(elmId);
}

function openMenu() {
	anime({
		targets: ".menubtn",
		top: "-420px",
		easing: 'easeInOutQuart',
		duration: 500
	});
}

function closeMenu() {
	anime({
		targets: ".menubtn",
		top: "-100px",
		easing: 'easeInOutQuart',
		duration: 500
	});
}

function isTutorialNow(tutorialCode) {
	if(!saveData.tutorialFlag) return false;
	return saveData.tutorialFlag[tutorialCode];
}

function closeTutorial(tutorialCode) {
	if(!saveData.tutorialFlag) {
		saveData.tutorialFlag = {}
	}
	saveData.tutorialFlag[tutorialCode] = 1;
	saveSessionData();
	tutorialCache[tutorialCode].style.display = "none";
}

function openTutorial(tutorialCode) {
	tutorialCache[tutorialCode].style.display = "block";
}

function enableUIById(elmId) {
	let elm = getElm(elmId);
	elm.style.display = "block";
}

function disableUIById(elmId) {
	let elm = getElm(elmId);
	elm.style.display = "none";
}

function createdPayload(data) {
	let payload = [];
	if(data) {
		for(var k in data) {
			payload.push({
				Key: k,
				TypeName: typeof data[k],
				Data: data[k]
			});
		}
	}
	return payload;
}

function parsePayload(payload) {
	let data = {};
	if(payload) {
		for(var d of payload) {
			switch(d.TypeName)
			{
			case "Integer":
			case "number":
				data[d.Key] = Number(d.Data);
				break;
				
			case "String":
				data[d.Key] = d.Data;
				break;
				
			default:
				data[d.Key] = d.Data;
				break;
			}
		}
	}
	
	return data;
}

function updateGameStat(data) {
	var html="";
	
	for(let game of data.ActiveGames) {
		if(game.GameId == 99) continue; //portalは表示しない
		
		if(game.GameId == 1) {
			//VCMain
			html += `
			<div class="nes-container with-title">
				<p class="title">${game.Title}</p>`;
			
			if(game.Session && game.Session.Status == 1) {
				html += `<div>冒険中！： ${game.Session.GameTitle}</div>`;
				
				for(let u of game.Session.GameUsers) {
					html += `<div>${u.Name}が冒険中！`;
					html += `<button type="button" id="cheer${game.GameId}" class="nes-btn is-primary" onclick="cheerSetup(${game.GameId}, ${u.UserId})">応援する！</button>`;
					html += "</div>";
				}
			}else{
				html +="<div>冒険の準備中…</div>";
			}
			
			html += `</div>
			<div style="height:10px;"></div>`;
		}else{
			let active = "ゲーム台は空いています";
			let plusOn = "";
			
			//それ以外
			if(game.ActiveTime == 0) {
				active = "メンテナンス中…";
			}
			
			if(game.Session && game.Session.Status == 1 && game.Session.UserId && game.Session.UserInfo) {
				active = game.Session.UserInfo.Name + "がプレイ中！";
				plusOn = `<button type="button" id="cheer${game.GameId}" class="nes-btn is-primary" onclick="cheerSetup(${game.GameId}, ${game.Session.UserId})">応援する！</button>`;
			}
			
			html += `
			<div class="nes-container with-title">
				<p class="title">${game.Title}</p>
				<div>${active}</div>
				${plusOn}
			</div>
			<div style="height:10px;"></div>`;
		}
	}
	
	getElm("gamelist").innerHTML = html;
	getElm("ws-state").innerHTML = "接続中"; //のユーザ:" + data.ActiveUsers.length + "人";
}

function createUserInfoUI(ud = userData) {
	getElm("fullname").innerText = ud.Name;
	getElm("level").innerText = ud.Level;
	getElm("gender").innerText = ud.Gender;
	getElm("age").innerText = ud.Age;
	getElm("job").innerText = ud.Job;
	getElm("personality").innerText = ud.Personality;
	getElm("motivation").innerText = ud.Motivation;
	getElm("weakness").innerText = ud.Weaknesses;
	getElm("backstory").innerText = ud.Background;
}


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// DEBUG 
//////////

let isDebugMode = true;
let myGameId = -1;
let gameIngo = {};
let gameEvent = {};
let sendQRIndex = 0;

async function setupDebugMenu() {
	gameEvent = await getMaster("GameEvent");
	
	let elm = getElm("dbgSelector");
	for(let game of gameInfo) {
		var option = document.createElement("option");
		option.text = game.GameTitle;
		option.value = game.Id;
		elm.appendChild(option);
	}
	
	elm.addEventListener("change", (event)=>{
		let elm = getElm("dbgSelector");
		filterAndShowDebugEvent(elm.value);
		localStorage.setItem("myGame", elm.value);
		myGameId = parseInt(elm.value);
	});
	
	const myGame = localStorage.getItem("myGame");
	if(myGame) {
		elm.selectedIndex = myGame;
		filterAndShowDebugEvent(myGame);
		myGameId = parseInt(myGame);
	}
}

function sendDebugQR() {
	const qrMagicScrollList = [
		"810f1f50-6a2b-4a8d-8908-a37b9afe9ec2",		//魔法スクロール1
		"8f47353a-a230-4a50-8e58-1ad1d46b2200",		//魔法スクロール2
		"404c7c46-0436-4c8e-80b9-e86029ef5eb6",		//魔法スクロール3
		"fa0e5db3-12d7-4f3e-b785-1aa1ef10ec4f",		//魔法スクロール4
		"3900742f-0c88-4d6e-9dff-13035d52ab64",		//魔法スクロール5
	];
	
	let qrStr = qrMagicScrollList[sendQRIndex];
	sendQREvent(qrStr, true);
	
	sendQRIndex++;
	if(sendQRIndex > 4) sendQRIndex=0;
}

async function gameShutdown() {
	let tgtGameId = parseInt(getElm("dbgShutdownId").value);
	if(isNaN(tgtGameId)) return;
	
	let gameHash = "";
	for(let game of activeGameInfo) {
		if(game.GameId == tgtGameId && game.Session && game.Session.Status == 1) {
			gameHash = game.Session.GameHash;
			break;
		}
	}
	if(gameHash == "") return;
	
	let req = await fetch(`${baseURI}/vc/gameend`, {
		method: 'POST',
		mode: 'cors',
		body: JSON.stringify({
			GameHash: gameHash,
			GameResult: 4
		})
	});
	let result = await req.json();
}

function resetTutorial() {
	saveSessionData();
}

function goodCheer() {
	cheerMessage(userData.UserId, myGameId, "がんばれ", 50);
}

function badCheer() {
	cheerMessage(userData.UserId, myGameId, "くたばれ", -50);
}

function dbgMsgSend() {
	let toUserId = userData.UserId;
	
	if(getElm("dbgMessage").value == "") return;
	
	let tgt = getElm("dbgTarget").value;
	if(tgt != "自分") {
		toUserId = parseInt(tgt)
	}
	
	cheerMessage(toUserId, myGameId, getElm("dbgMessage").value, 0);
}

function filterAndShowDebugEvent(gameId) {
	let elm = getElm("eventDebug");
	let html = "";
	for(let evt of gameEvent) {
		if(evt.Release == "") continue;
		if(evt.Id >= 1000) continue;
		if(evt.Target == -1 || evt.Target == gameId) {
			html += `<button type="button" class="nes-btn is-primary" onclick=sendTestEvent(${evt.Id})>${evt.Description}</button><div style="height:10px;"></div>`;
		}
	}
	elm.innerHTML = html;
	enableUIById("cheerDebug");
}

function reCreateUser() {
	loadPage(PAGE.USER_CREATE);
}

async function userIdHandOver() {
	let val = getElm("dgbUserIdHandOver").value;
	let userId = parseInt(val);
	
	let req = await fetch(`${baseURI}/vc/user/${userId}`, {
		mode: 'cors'
	});
	let result = await req.json();
	userData = result.UserData;
	localStorage.setItem("UserData", JSON.stringify(userData));
	saveSessionData();
	
	firstView();
}

async function sendTestEvent(evtId) {
	let json = {
		SessionId: wsSessionId,
		Command: CMD.SEND_EVENT,
		GameId: myGameId,
		FromId: 99,
		EventId: evtId,
		Payload: []
	};
	
	switch(evtId) {
	case 1002:
		json.Payload = createdPayload({
			GetCoin: 250+Math.ceil(Math.random()*500)
		});
		break;
	}
	
	ws.send(JSON.stringify(json));
}
let debugData = {};

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// 通知
//////////
//サービスワーカーの登録
let reg;

if ('serviceWorker' in navigator) {
	navigator.serviceWorker.register("/serviceworker.js")
	.then(function(registration) {
			console.log('Service Worker registered with scope:', registration.scope);
			reg = registration;
		})
	.catch(function(error) {
		console.log('Service Worker registration failed:', error);
	});
}

function initializePush() {
    // プッシュ通知の許可をユーザーに求める
    Notification.requestPermission().then(function(permission) {
        if (permission === 'granted') {
            subscribeUserToPush(reg);
        } else {
            console.log('プッシュ通知の許可が得られませんでした');
        }
    });
}

// function notifyMe() {
// 	if (!("Notification" in window)) {
// 		// ブラウザーが通知に対応しているか調べる
// 		alert("このブラウザーはデスクトップ通知に対応していません。");
// 	} else if (Notification.permission === "granted") {
// 		// 通知権限が既に付与されているかどうかを調べる。
// 		// そうであれば、通知を作成
// 		const notification = new Notification("こんにちは！");
// 	} else if (Notification.permission !== "denied") {
// 		// ユーザーにその権限を要求する必要がある
// 		Notification.requestPermission().then((permission) => {
// 			// ユーザーが許可したら、通知を作成
// 			if (permission === "granted") {
// 				const notification = new Notification("こんにちは！");
// 			}
// 		});
// 	}
	
// 	//SessionIdをキーにしてJoinを返す
// 	let json = {
// 		SessionId: wsSessionId,
// 		Command: CMD.SEND_EVENT,
// 		EventId: 1000,
// 		Payload: [{
// 			Key: "GameId",
// 			TypeName: "Integer",
// 			Data: "2",
// 		}]
// 	};
// 	ws.send(JSON.stringify(json));
// }

let sub;
function subscribeUserToPush(registration) {
	// TODO: 公開鍵の取得をどうにかする
    const applicationServerKey = urlB64ToUint8Array('BLheYK_ZKUqWjTUX4OEnG6eytFDJ79H3EQczFEqRYgF2Plp5W-D8Eki3E2--EWqKfxN_-FSTyXF0MJRqQJrYvZA');
    registration.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: applicationServerKey
    })
    .then(function(subscription) {
        console.log('ユーザーがプッシュ通知に登録されました:', subscription);
		sub = subscription;
        // サーバーにPushSubscriptionを送信する
        saveSubscription();
    })
    .catch(function(error) {
        console.log('プッシュ通知の登録に失敗しました:', error);
    });
}

function saveSubscription() {
	// サーバーにPushSubscriptionを送信する
	fetch(`${baseURI}/vc/subscribe`, {
		method: 'POST',
		headers: {
			'Content-Type': 'application/json'
		},
		body: JSON.stringify({
			subscription: sub,
			UserId: userData.UserData.Id
		})
	})
	.then(function(response) {
		if (response.ok) {
			console.log('PushSubscriptionがサーバーに送信されました');
		} else {
			console.log('PushSubscriptionの送信に失敗しました');
		}
	})
	.catch(function(error) {
		console.log('PushSubscriptionの送信中にエラーが発生しました:', error);
	});
}

function sendSubscriptionToServer() {
    // サーバーにPushSubscriptionを送信する
    fetch(`${baseURI}/vc/send`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
			subscription: sub,
			UserId: userData.UserData.Id
		})
    })
    .then(function(response) {
        if (response.ok) {
            console.log('PushSubscriptionがサーバーに送信されました');
        } else {
            console.log('PushSubscriptionの送信に失敗しました');
        }
    })
    .catch(function(error) {
        console.log('PushSubscriptionの送信中にエラーが発生しました:', error);
    });
}

// VAPIDキーをUint8Arrayに変換する関数
function urlB64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
}

</script>
</head>
<body>
<section class="layout">
	<!--
	<div class="header">
		<button type="button" id=""class="nes-btn is-primary" onclick="window.location.reload();">更新</button>
		<h1 class="nes-header checkbg">冒険者たちの集会場</h1>
	</div>
	-->
	
	<div id="modal-connects" class="modal">
		<div class="nes-container with-title status">
			<p class="title">ツウシンジョウタイ</p>
			<div id="ws-state" class="center">未接続</div>
		</div>
	</div>
	
	<div id="modal-error" class="modal">
		<div class="modal-content">
			<div id="cheer" class="nes-container is-rounded with-title status">
				<p class="title">エラー</p>
				
				<div id="errorMessage"></div>
				<div style="height:10px;"></div>
				<div class="right">
					<button type="button" class="nes-btn is-primary" onclick="closeError();">ＯＫ</button>
				</div>
			</div>
			
			<div id="closeModal" onclick=closeError()>&times;</div>
		</div>
	</div>
	
	<div id="modal-cheer" class="modal">
		<div class="modal-content">
			<div id="cheer" class="nes-container is-rounded with-title status">
				<p class="title">オウエン</p>
				
				<div id="cheerMsg">
				<span id="cheerUserName"></span>サンにメッセージを届けよう！<br /><br />
				書いたメッセージの内容に応じて、良い事や悪いことが起きるぞ。
				</div>
				<br /><br />
				
				<div class="nes-field">
					<label for="name_field">オウエン</label>
					<input type="text" id="cheerMessage" class="nes-input">
				</div>
				<div style="height:10px;"></div>
				<div class="right">
					<button type="button" id="test" class="nes-btn is-primary" onclick="sendCheerMessage();">ソウシン</button>
				</div>
			</div>
			
			<div id="closeModal" onclick=closeCheer()>&times;</div>
		</div>
	</div>
	
	<div>
		<div id="page-launch">
			<!--
			<div class="nes-container with-title status">
				<p class="title">ページ準備中</p>
				
				しばらく待ってね
			</div>
			-->
		</div>
	</div>
	
	<!--
		<div style="height:50px;"></div>
		
		<div class="nes-container is-rounded is-rounded with-title status">
			<p class="title">ログ</p>
			<div class="nes-field">
				<section id="msglog" class="message-list">
				</section>
				<div style="height:50px;"></div>
			</div>
		</div>
	<//div>
	-->
	
	<div id="summon-effect" class="modal">
		<div class="nes-container status" style="display:none;">
			<br /><br /><br />
			<p>召喚中！！</p>
			<br /><br /><br />
			<progress class="nes-progress is-primary" id="summongauge" value="0" max="100"></progress>
		</div>
	</div>
	
	<div id="ask-send-effect" class="nes-container status" style="display:none;">
		<p>アンケート送信…</p>
		<progress class="nes-progress is-primary" id="askgauge" value="0" max="100"></progress>
	</div>

	<div id="modal-adventure-log" class="modal">
		<div class="modal-content">
			<div class="nes-container is-rounded with-title status log">
				<p class="title">冒険譚</p>
				
				<div id="adventureLogTitle"></div>
				<br />
				<div id="adventureLogMsg" class="scrollLog"></div>
				<div style="height:10px;"></div>
				<div class="center">
					<button type="button" class="nes-btn is-primary" onclick="closeHistory();">とじる</button>
				</div>
			</div>
			
			<div id="closeModal" onclick=closeHistory()>&times;</div>
		</div>
	</div>
	
	<div id="modal-reawrd-log" class="modal">
		<div class="modal-content">
			<div class="nes-container is-rounded with-title status log">
				<p class="title">報酬をゲット！</p>
				
				<div id="reawrdLogTitle"></div>
				<br />
				<div id="reawrdLogMsg"></div>
				<div style="height:10px;"></div>
				<div class="center">
					<button type="button" class="nes-btn is-primary" onclick="closeRewardLog();">とじる</button>
				</div>
			</div>
			
			<div id="closeModal" onclick=closeRewardLog()>&times;</div>
		</div>
	</div>
	
	<div id="page-tutorial-pwa" style="display:none;">
		<div class="nes-container with-title status">
			<p class="title">こんにちは</p>
			
			手間だけどPWAで動かしてね<br />
			<br /><br />
			(仮)手順の紹介をするよ<br />
			<br /><br />
			<div class="right">
				<button type="button" class="nes-btn is-primary" onclick="pwaSkip();">ＯＫ</button>
			</div>
		</div>
	</div>
	
	<div id="page-cheer" style="display:none;">
		<div class="nes-container with-title status">
			<p class="title">オウエン</p>
			<div class="nes-field">
				<label for="name_field">オウエン</label>
				<input type="text" id="msg" class="nes-input">
			</div>
			<div style="height:10px;"></div>
			<div class="right">
				<button type="button" id="test" class="nes-btn is-primary" onclick="testEvent();">ソウシン</button>
			</div>
		</div>
	</div>
	
	<div id="page-hello-world" class="main">
		<div class="main-block">
			<div class="header">
				<h1 class="nes-header checkbg">HELLO WORLD</h1>
			</div>
			
			<div style="height:80px;"></div>
			
			<div id="page-tutorial-hello">
				<div class="nes-balloon from-left">
					<div class="center">
						バンタン-〇-コネクトへようこそ！<br />
						<br /><br /><br />
						バンタンコネクトとは、ソツテンワールド(仮)を楽しむために作られた一日限りのサービスです。<br />
						<br /><br /><br />
						会場のゲームに自分の分身を登場<<リンク>>させ、AIにより生成される冒険譚を楽しんだり、<br />
						遊んでいるプレイヤーを「応援」することで、プレイヤーを助けることができます。<br />
						自分が遊んだゲームの出来事が、ほかのプレイヤーのゲームに影響することもあるとか…？<br />
						<br />
						会場だけで体験可能な、ふだんはできない遊び方を楽しんでいってください。<br />
						<br />
						まずは、自分の分身となる冒険者を『召喚』しましょう！<br />
						<button type="button" class="nes-btn is-success" onclick="nextTutorial()">キャラクリエイトへ</button>
						<br /><br /><br />
						召喚された冒険者たちがわちゃわちゃ動くAIゲーム、<br />
						「いぬのだいぼうけん」もお楽しみに！
						<br /><br /><br />
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<div id="page-user-create" class="main">
		<div class="main-block">
			<div class="header">
				<h1 class="nes-header checkbg">転生の儀</h1>
			</div>
			
			<div style="height:150px;"></div>
			
			<div id="page-tutorial-summon">
				<div class="nes-balloon from-left">
					<div class="center">
						これから自分の分身を『召喚』します<br />
						<br />
						この世界の神はAI神です。<br />
						召喚にあたり、AI神があなたのステータスを勝手に決めます。<br />
						しかし一部のステータスについては調整が可能となっていますので、用意された質問事項に回答をお願いします。<br />
						<br />
						ちなみに回答しなくても大丈夫です。回答しない場合は、AIが勝手に決めた設定でキャラクターが生成されます。<br />
						<br />
					</div>
				</div>
			</div>
			
			<div class="nes-container with-title status">
				<p class="title">冒険の書を作る</p>
				<br /><br /><br />
				
				<div class="nes-container with-title">
					<p class="title">名前</p>
					
					<div class="nes-field">
						<input type="text" id="username" class="nes-input">
						<br />
						<b>※ゲーム環境で公開されます。</b><br />
						本名は避けてもらえると助かります。<br /><br />
						※記載がない場合はAIが勝手に命名します。<br />
						<br />
						長さに応じて愛称または本名が自動生成されます。<br />
					</div>
				</div>
				
				<br />
				いくつか質問をします。<br />
				<br />
				<br />
				
				<div class="nes-container with-title">
					<p class="title">質問1: 召喚先</p>
					
					召喚したキャラはどのような環境で成長しますか？<br />
					<br />
					
					<div class="nes-select is-success">
						<select required id="question1">
						<option value="0" disabled selected hidden>選択しましょう...</option>
						<option value="1">貴族の屋敷</option>
						<option value="2">馬小屋</option>
						<option value="3">一般家庭</option>
						<option value="4">山中(野生児化)</option>
						</select>
					</div>
				</div>
				
				<div style="height:20px;"></div>
				
				<div class="nes-container with-title">
					<p class="title">質問2: 成し遂げたいこと</p>
					
					召喚したキャラが冒険で目指すこと。<br />
					<br />
					
					<div class="nes-select is-warning">
						<select required id="question2">
						<option value="0" disabled selected hidden>選択しましょう...</option>
						<option value="1">お宝見つけて一攫千金を狙う</option>
						<option value="2">最強のプレイヤーになる</option>
						<option value="3">安全に細々と暮らす</option>
						<option value="4">ワンワン！！ ワオーン！！</option>
						</select>
					</div>
				</div>
				
				<div style="height:20px;"></div>
				
				<div class="nes-container with-title">
					<p class="title">質問3: 弱点</p>
					
					召喚キャラの弱点を選んでください<br />
					<br />
					
					<div class="nes-select is-error">
						<select required id="question3">
						<option value="0" disabled selected hidden>選択しましょう...</option>
						<option value="1">無謀である</option>
						<option value="2">承認欲求が強い</option>
						<option value="3">飽きっぽい</option>
						<option value="4">ワンワン！！ ワオーン！！</option>
						</select>
					</div>
				</div>
				
				<div style="height:20px;"></div>
				
				<div class="nes-container with-title">
					<p class="title">質問4: アドバイス</p>
					
					<label for="error_select">召喚キャラにアドバイスしましょう</label>
					<div class="nes-select is-normal">
						<select required id="question4">
						<option value="0" disabled selected hidden>選択しましょう...</option>
						<option value="1">安全に頑張りましょう</option>
						<option value="2">命懸けの冒険をしよう</option>
						<option value="3">友達たくさん作ってね</option>
						<option value="4">ワンワン！！ ワオーン！！</option>
						</select>
					</div>
				</div>
				
				<div style="height:35px;"></div>
				
				<div class="center">
					<button type="button" id="usercreate" class="nes-btn is-primary">召喚する！！</button>
				</div>
				
				<div style="height:50px;"></div>
			</div>
		</div>
	</div>
	
	<!-- //聖剣3っぽいメニューを作る -->
	<div id="page-main" class="main" style="display:none">
		<div class="main-content">
			
			<div class="main-block left-top">
				<div class="header">
					<h1 class="nes-header checkbg">ゲーム動画</h1>
					<button type="button" class="nes-btn is-primary is-rounded" onclick="openTutorial(PAGE.TUTORIAL_PROFILE)">？</button>
				</div>
				
				<div style="height:150px;"></div>
				
				<div class="nes-container is-rounded with-title video"><p class="title">開発動画</p>
				<div id="youtubeLive" class="center"></div>
				</div>
				
				<div style="height:25px;"></div>
				
				以下、バンタンコネクト対応ゲームの紹介です。<br />
				
				<div class="nes-container is-rounded with-title status">
					<p class="title">いぬのだいぼうけん</p>
					
					大きいスクリーンに映っているゲームが、かの有名な「いぬのだいぼうけん」、略して「いぬ大」です！<br />
					<br />
					主人公「いぬ」が、比較的何もしていない平和な魔王「Tappei」を倒すべく、レベル上げとお宝を見つけるためにダンジョンに潜り、沼ってしまう物語です。<br />
				</div>
				
				//ここから先は当日キャプションをコピペ
				<div style="height:25px;"></div>
				
				<div class="nes-container is-rounded with-title status">
					<p class="title">Confront</p>
					
					戦いは好きか？<br />
				</div>
				
				<div style="height:25px;"></div>
				
				<div class="nes-container is-rounded with-title status">
					<p class="title">ブルスラアクション</p>
					
					高難度ゲーム！<br />
				</div>
				
				<div style="height:25px;"></div>
				
				<div class="nes-container is-rounded with-title status">
					<p class="title">玩具箱</p>
					
					抜け出せるか、この館から…<br />
				</div>
				
				<div style="height:25px;"></div>
				
				<div class="nes-container is-rounded with-title status">
					<p class="title">チェンガ</p>
					
					生き残るために変化しろ！<br />
				</div>
			</div>
			
			<!-- アンケート -->
			<div class="main-block">
				<div class="header">
					<h1 class="nes-header checkbg">ゲームアンケート</h1>
					<button type="button" class="nes-btn is-primary is-rounded" onclick="openTutorial(TUTORIAL.GAMEASK)">？</button>
				</div>
				
				<div style="height:100px;"></div>
				
				<div id="page-game-ask">
					<div id="page-tutorial-gameask">
						<div class="nes-balloon from-left with-title">
							<p class="title">アンケートに回答しよう！</p>
							
							会場内のゲームを遊んだら、ぜひアンケートへのご回答をお願いします。<br />
							学生の今後の励みになります！<br />
							<br />
							<br />
							※アンケートに回答すると、1ゲームにつき1回だけ経験値とGOLDがもらえます！<br />
							<div class="right">
								<button type="button" class="nes-btn is-primary" onclick="closeTutorial(TUTORIAL.GAMEASK);">ＯＫ</button>
							</div>
						</div>
					</div>
					
					<div id ="userprof" class="nes-container is-rounded status">
						<div class="nes-container with-title">
							<p class="title">遊んだゲーム</p>
							
							<div class="nes-select is-normal">
								<select required id="game-ask-0">
								</select>
							</div>
						</div>
						
						<div class="nes-container with-title">
							<p class="title">性別</p>
							
							<div class="nes-select is-normal">
								<select required id="game-ask-1">
								<option value="0" disabled selected hidden>必須項目(タップして選択)</option>
								<option value="1">男性</option>
								<option value="2">女性</option>
								<option value="3">その他</option>
								<option value="4">無回答</option>
								</select>
							</div>
						</div>
						
						<div style="height:25px;"></div>
						
						<div class="nes-container with-title">
							<p class="title">ご年齢層</p>
							
							<div class="nes-select is-normal">
								<select required id="game-ask-2">
								<option value="0" disabled selected hidden>必須項目(タップして選択)</option>
								<option value="1">0～9歳</option>
								<option value="2">10～19歳</option>
								<option value="3">20～29歳</option>
								<option value="4">30～39歳</option>
								<option value="5">40～49歳</option>
								<option value="6">50～59歳</option>
								<option value="7">60歳～</option>
								<option value="8">その他</option>
								</select>
							</div>
						</div>
						
						<div style="height:25px;"></div>
						
						<div class="nes-container with-title">
							<p class="title">オリジナリティ</p>
							
							<label for="error_select">ゲームのオリジナリティはありましたか？ <br /><br />
							既存で販売されているゲームなどとは違う新しさがあったかなどの視点で問題ございません</label>
							<div class="nes-select is-normal">
								<select required id="game-ask-3">
								<option value="0" disabled selected hidden>必須項目(タップして選択)</option>
								<option value="1">1</option>
								<option value="2">2</option>
								<option value="3">3</option>
								<option value="4">4</option>
								<option value="5">5</option>
								<option value="6">6</option>
								<option value="7">7</option>
								<option value="8">8</option>
								<option value="9">9</option>
								<option value="10">10</option>
								</select>
							</div>
							<div>
								<label for="error_select">なかった…1<br />あった…10<br />でお願いします</label>
							</div>
						</div>
						
						<div style="height:25px;"></div>
						
						<div class="nes-container with-title">
							<p class="title">面白さ</p>
							
							<label for="error_select">ゲームは面白かったですか？</label>
							<div class="nes-select is-normal">
								<select required id="game-ask-4">
								<option value="0" disabled selected hidden>必須項目(タップして選択)</option>
								<option value="1">1</option>
								<option value="2">2</option>
								<option value="3">3</option>
								<option value="4">4</option>
								<option value="5">5</option>
								<option value="6">6</option>
								<option value="7">7</option>
								<option value="8">8</option>
								<option value="9">9</option>
								<option value="10">10</option>
								</select>
							</div>
							<div>
								<label for="error_select">つまらない…1<br />どちらでもない…5<br />おもしろかった…10<br />でお願いします</label>
							</div>
						</div>
						
						<div style="height:25px;"></div>
						
						<div class="nes-container with-title">
							<p class="title">クォリティ</p>
							
							<label for="error_select">ゲームのクォリティはいかがでしたか？</label>
							<div class="nes-select is-normal">
								<select required id="game-ask-5">
								<option value="0" disabled selected hidden>必須項目(タップして選択)</option>
								<option value="1">1</option>
								<option value="2">2</option>
								<option value="3">3</option>
								<option value="4">4</option>
								<option value="5">5</option>
								<option value="6">6</option>
								<option value="7">7</option>
								<option value="8">8</option>
								<option value="9">9</option>
								<option value="10">10</option>
								</select>
							</div>
							<div>
								<label for="error_select">低い…1<br />どちらでもない…5<br />高い…10<br />でお願いします</label>
							</div>
						</div>
						
						<div style="height:25px;"></div>
						
						<div class="nes-container with-title">
							<p class="title">ゲームルール</p>
							
							<label for="error_select">
							ルールを理解して遊ぶことができましたか？ <br />
							</label>
							<div class="nes-select is-normal">
								<select required id="game-ask-6">
								<option value="0" disabled selected hidden>必須項目(タップして選択)</option>
								<option value="1">1</option>
								<option value="2">2</option>
								<option value="3">3</option>
								<option value="4">4</option>
								<option value="5">5</option>
								<option value="6">6</option>
								<option value="7">7</option>
								<option value="8">8</option>
								<option value="9">9</option>
								<option value="10">10</option>
								</select>
							</div>
							<div>
								<label for="error_select">できなかった…1<br />できた…10<br />でお願いします</label>
							</div>
						</div>
						
						<div style="height:25px;"></div>
						
						<div class="nes-container with-title">
							<p class="title">リプレイ性</p>
							
							<label for="error_select">また遊びたいと思いますか？</label>
							<div class="nes-select is-normal">
								<select required id="game-ask-7">
								<option value="0" disabled selected hidden>必須項目(タップして選択)</option>
								<option value="1">1</option>
								<option value="2">2</option>
								<option value="3">3</option>
								<option value="4">4</option>
								<option value="5">5</option>
								<option value="6">6</option>
								<option value="7">7</option>
								<option value="8">8</option>
								<option value="9">9</option>
								<option value="10">10</option>
								</select>
							</div>
							<div>
								<label for="error_select">思わない…1<br />思う…10<br />でお願いします</label>
							</div>
						</div>
						
						<div style="height:25px;"></div>
						
						<div class="nes-container with-title">
							<p class="title">特筆する点</p>
							(回答は任意です)<br />
							特に面白かった点があればぜひご記載ください
							<textarea id="game-ask-8" name="game-ask-8" class="nes-textarea ask-text"></textarea>
						</div>
						
						<div style="height:25px;"></div>
						
						<div class="nes-container with-title">
							<p class="title">改善点など</p>
							(回答は任意です)<br />
							物足りなかった点など、改善点があればご記載ください
							<textarea id="game-ask-9" name="game-ask-9" class="nes-textarea ask-text"></textarea>
						</div>
						
						<div style="height:25px;"></div>
						
						<div class="center">
							<button type="button" id="game-ask-send" class="nes-btn is-primary" onclick=sendGameAsk()>送信</button>
						</div>
					</div>
				</div>
				
				<div style="height:150px;"></div>
			</div>
			
			<div class="main-block right-top">
				<div class="header">
					<h1 class="nes-header checkbg">仲間との交流</h1>
				</div>
				
				<div style="height:100px;"></div>
				
				<div id ="page-friend-list">
					<div class="nes-container is-rounded with-title status">
						<p class="title">交流の記録</p>
						<div style="height:10px;"></div>
						<div id="friendList"></div>
					</div>
				</div>
				
				<div style="height:150px;"></div>
			</div>
			
			<div class="main-block left-center">
				
				<div class="header">
					<h1 class="nes-header checkbg">あそびかた</h1>
				</div>
				
				<div style="height:100px;"></div>
				
				<div style="height:150px;"></div>
			
			</div>
			
			<div id="page-main-menu" class="main-block true-center">
				
				<div class="header">
					<h1 class="nes-header checkbg">冒険者の集会場</h1>
					<button type="button" class="nes-btn is-primary is-rounded" onclick="openTutorial(PAGE.TUTORIAL_PROFILE)">？</button>
				</div>
				
				<div style="height:100px;"></div>
				
				<div id ="gameinfo" class="nes-container is-rounded with-title status">
					<p class="title">ゲーム稼働状況</p>
					
					<div id="gamelist">確認中…</div>
				</div>
				
				<div style="height:50px;"></div>
				
				<div id="main-api-effect" class="nes-container status" style="display:none;">
					<p>通信中！！</p>
					<progress class="nes-progress is-primary" id="mainworkgauge" value="0" max="100"></progress>
				</div>
				
				<div style="height:50px;"></div>
				
				<div id ="userinfo" class="nes-container is-rounded with-title status" style="display:none;">
					<p class="title">ステータス</p>
					<div class="playerName" id="playerName"></div><br />
					<div class="playerLevel" id="playerLevel"></div>
					次のレベルまで: <span class="playerNextExp" id="playerNextExp"></span><br />
					<progress class="nes-progress is-primary playerLevelGauge" id="nextlv" value="0" max="100"></progress><br />
					<br />
					<div class="playerGold">所持ゴールド: <span id="playerGold"></span></div>
				</div>
								
				<div style="height:250px;"></div>
				
				<div style="height:50px;"></div>
				
				<div>
					<div class="nes-container is-rounded with-title status">
						<p class="title">UIデバッグ用</p>
						
						メッセージ
						<button type="button" class="nes-btn is-primary" onclick="cheerSetup(100, 50);">応援</button>
					</div>
				</div>
				
				
		
		<div id="debugitem" class="nes-container with-title leftmenu" style="display:none;">
			<p class="title">デバッグメニュー</p>
			
			<div class="nes-container with-title">
				<p class="title">機能テスト</p>
				
				<div style="height:10px;"></div>
				GameId<input type="text" id="dbgShutdownId" class="nes-input">
				<button type="button" class="nes-btn is-primary" onclick="gameShutdown();">ゲーム終了</button>
				
				<div style="height:25px;"></div>
				<button type="button" class="nes-btn is-primary" onclick="playNextVideo();">次の動画</button>
				
				<div style="height:10px;"></div>

				<button type="button" id="" class="nes-btn is-primary" onclick="initializePush();">通知登録</button>
				<div style="height:10px;"></div>

				<button type="button" id="" class="nes-btn is-primary" onclick="sendSubscriptionToServer();">通知送信</button>
				<div style="height:10px;"></div>

				<button type="button" class="nes-btn is-primary" onclick="reCreateUser();">ユーザ登録やり直す</button><br />
				NOTE: 作り直すまでデータは消えない<br />
				
				<div style="height:10px;"></div>
				GameId<input type="text" id="dgbUserIdHandOver" class="nes-input">
				<button type="button" class="nes-btn is-primary" onclick="userIdHandOver();">ユーザID引継ぎ</button>
				
				<div style="height:10px;"></div>
				<button type="button" class="nes-btn is-primary" onclick="resetTutorial();">チュートリアルリセット</button>
				
				<div style="height:20px;"></div>
			</div>
			
			<div style="height:50px;"></div>
				
			<div class="nes-container with-title">
				<p class="title">メッセージデバッグ</p>
				<br />
				対象を「自分」のままにすると自分にメッセージを送信します。<br />
				自分以外のプレイヤーにメッセージを送りたい場合は、そのプレイヤーのUserIdを入力してください。<br />
				<br />
				対象<input type="text" id="dbgTarget" class="nes-input" value="自分">
				メッセージ<input type="text" id="dbgMessage" class="nes-input">
				<button type="button" class="nes-btn is-primary" onclick="dbgMsgSend();">送信</button>
			</div>
			
			<div style="height:50px;"></div>
			
			<div class="nes-container with-title">
				<p class="title">ユーザパラメータ</p>
				
				<table class="nes-table is-bordered is-centered">
				<tbody>
					<tr>
						<td>UserId</td>
						<td id="dbgUserId"></td>
					</tr>
					<tr>
						<td>AvatarType</td>
						<td id="dbgAvatarType"></td>
					</tr>
				</tbody>
				</table>
				<button type="button" class="nes-btn is-primary" onclick="levelUp();">レベルアップ</button>
			</div>

			<div style="height:50px;"></div>
		</div>
		
		<div id="eventtest" class="nes-container with-title leftmenu">
			<p class="title">テストイベント</p>
			
			<div id="cheerDebug" style="display:none;">
				NOTE: Emotionはそれぞれ50)<br />
				<button type="button" class="nes-btn is-primary" onclick=goodCheer()>よい応援</button><div style="height:10px;"></div>
				<button type="button" class="nes-btn is-primary" onclick=badCheer()>わるい応援</button><div style="height:10px;"></div>
			</div>
			
			<div style="height:20px;"></div>
			
			<label for="error_select">イベントを送信するデバッグ対象のゲーム</label>
			<div id="dbgEvent" class="nes-select is-normal">
				<select required id="dbgSelector">
				<option value="0" disabled selected hidden>選択しましょう...</option>
				</select>
			</div>
			
			<div style="height:20px;"></div>
			
			<div id="eventDebug"></div>
			
			<div style="height:20px;"></div>
			
			<div id="debugNote">
				NOTE: 会場イベントは連投できない(ゲームに飛ぶのは10秒に1回のみ)<br />
				NOTE: アーティファクト出現イベントは、一回の冒険中に1度しか出ない<br />
			</div>
		
			<div style="height:50px;"></div>
			
			<div class="nes-container with-title">
				<p class="title">テストQR</p>
				<br />
				<button type="button" class="nes-btn is-primary" onclick="sendQREvent('810f1f50-6a2b-4a8d-8908-a37b9afe9ec2')">リンク1</button><div style="height:10px;"></div>
				<button type="button" class="nes-btn is-primary" onclick=sendDebugQR()>スクロール</button><div style="height:10px;"></div>
			</div>
		</div>
				
				<div style="height:150px;"></div>
			</div>
			
			<div id="page-qr-search" class="main-block right-center">
				
				<div class="header">
					<h1 class="nes-header checkbg">ＱＲ検索</h1>
					<button type="button" class="nes-btn is-primary is-rounded" onclick="openTutorial(TUTORIAL.QR)">？</button>
				</div>
				
				<div style="height:100px;"></div>
				
				<div id="page-tutorial-qr">
					<div class="nes-balloon from-left with-title">
						<p class="title">ＱＲ検索をやってみよう</p>
						<br />
						このWebページから、ＱＲコードを読み取ることができます。<br />
						会場を探索し、ＱＲコードを読み込みましょう！<br />
						<br />
						具体的には、会場内に「マジックスクロール」や「冒険のトビラ」と書かれた、ＱＲコードが描かれたパネルが置かれているはずです。<br />
						これらを探しましょう。<br />
						(この２種のＱＲコードしか対応していません)<br />
						<br />
						読み込むと探索魔法が発動し、冒険に有利な効果が発生します。<br />
						冒険のトビラとマジックスクロールはそれぞれ別の効果となります。<br />
						<br />
						<br />
						冒険のトビラ： 探索魔法「リンク」を発動します。<b>遊ぶゲームに冒険者の情報を反映させます</b><br />
						<br />
						マジックスクロール： 適当な探索魔法が書かれており、それらを発動します。<b>さまざまな効果がランダムで発生します。何が起きるかはお楽しみに！</b><br />
						<div class="right">
							<button type="button" class="nes-btn is-primary" onclick="closeTutorial(TUTORIAL.QR);">ＯＫ</button>
						</div>
					</div>
				</div>
				
				<div class="nes-container is-rounded with-title status">
					<p class="title">ＱＲ探索</p>
					<div class="center">
						会場のQRコードを読み込もう！<br /><br />
						※QRの読み取りのために、カメラの許可をお願いします。
						<button type="button" id="qrscan" class="nes-btn is-primary" onclick="readQR();">ＱＲ読み込み</button><br /><br />
						<button type="button" id="qrscancancel" class="nes-btn is-primary" onclick="cencelQR();">キャンセル</button>
					</div>
					<div id="reader"></div>
					<div id="qrresult">読み込み結果</div>
				</div>
				
				<div style="height:25px;"></div>
				
				<div class="nes-container is-rounded with-title status">
					<p class="title">見つけよう</p>
					<div class="center">
						会場にある以下の画像を見つけよう<br /><br />
						
						<br />
						<br />
					</div>
				</div>
				
				<div style="height:150px;"></div>
			</div>
			
			<div class="main-block left-bottom">
				<div class="header">
					<h1 class="nes-header checkbg">冒険の記録</h1>
					<button type="button" class="nes-btn is-primary is-rounded" onclick="openTutorial(PAGE.TUTORIAL_PROFILE)">？</button>
				</div>
				
				<div style="height:100px;"></div>
				
				<div id ="page-game-history">
					<div class="nes-container is-rounded with-title status">
						<p class="title">みんなの冒険の記録</p>
						<div style="height:10px;"></div>
						<div id="gameHistory"></div>
					</div>
				</div>
				
				<div style="height:150px;"></div>
			</div>
			
			<div class="main-block center-bottom">
				<div id="page-user-profile">
					<div class="header">
						<h1 class="nes-header checkbg">冒険者プロフィール</h1>
						<button type="button" class="nes-btn is-primary is-rounded" onclick="openTutorial(PAGE.TUTORIAL_PROFILE)">？</button>
					</div>
					
					<div style="height:100px;"></div>
					
					<div id ="userprof" class="nes-container is-rounded with-title status">
						<p class="title">冒険者ステータス</p>
						
						<div class="nes-container with-title">
							<p class="title">名前</p>
							<div id="fullname"></div>
						</div>
						
						<div style="height:25px;"></div>
						
						<div class="nes-table-responsive">
							<table class="nes-table is-bordered is-centered">
							<tbody>
								<tr>
									<td>レベル</td>
									<td id="level"></td>
								</tr>
								<tr>
									<td>性別</td>
									<td id="gender"></td>
								</tr>
								<tr>
									<td>年齢</td>
									<td id="age"></td>
								</tr>
								<tr>
									<td>職業</td>
									<td id="job"></td>
								</tr>
							</tbody>
							</table>
							
							<div style="height:10px;"></div>
							
							<div class="nes-container with-title">
								<p class="title">個性</p>
								<div id="personality"></div>
							</div>
							
							<div style="height:10px;"></div>
							
							<div class="nes-container with-title">
								<p class="title">やる気</p>
								<div id="motivation"></div>
							</div>
							
							<div style="height:10px;"></div>
							
							<div class="nes-container with-title">
								<p class="title">弱点</p>
								<div id="weakness"></div>
							</div>
							
							<div style="height:10px;"></div>
							
							<div class="nes-container with-title">
								<p class="title">バックストーリー</p>
								<div id="backstory"></div>
							</div>
						</div>
					</div>
					
					<div style="height:50px;"></div>
					
					<div id ="userprof" class="nes-container is-rounded with-title status">
						<p class="title">旅の記録</p>
						<div style="height:10px;"></div>
						<div id="history">
						</div>
					</div>
				</div>
				
				<div style="height:150px;"></div>
				
				<div class="right">
					<button type="button" class="nes-btn is-error" onclick="reCreateUser();">再度召喚する</button><br />
					※召喚しなおすまでデータは消えません！<br />
				</div>
				
				<div style="height:150px;"></div>
			</div>
			
			<div id="page-credit" class="main-block right-bottom">
				<div class="header">
					<h1 class="nes-header checkbg">クレジット</h1>
				</div>
				
				<div style="height:100px;"></div>
				
				<div class="nes-container is-rounded with-title status">
					<p class="title">PixelMplus</p>
					M+ FONT LICENSE<br />
					-------<br />
					Itou Hiroki<br />
					<a href="https://itouhiro.hatenablog.com/entry/20130602/font">作者ページ</a>
				</div>
				
				<div style="height:25px;"></div>
				
				<div class="nes-container is-rounded with-title status">
					<p class="title">NES.css</p>
					<pre class="">MIT License

Copyright (c) 2018 B.C.Rikko <https://github.com/BcRikko>

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
					</pre>
					-------<br />
					<a href="https://nostalgic-css.github.io/NES.css/">Github</a><br />
				</div>
				
				<div style="height:25px;"></div>
				
				<div class="nes-container is-rounded with-title status">
					<p class="title">anime.js</p>
					<pre class="">MIT License
				
				The MIT License

Copyright (c) 2023 Julian Garnier

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
					</pre>
					-------<br />
					<a href="https://github.com/juliangarnier/anime">Github</a><br />
				</div>
				
				<div style="height:25px;"></div>
				
				<div class="nes-container is-rounded with-title status">
					<p class="title">ChatGPT</p>
					<pre class="">
					このコンテンツは文章・一部の画像生成にChatGPTを使用しています。
					<br />
				</div>
			</div>
		</div>
		
		<div style="height:150px;"></div>
	</div>
	
	<div id ="mainmenu" class="menubtn" style="display:none">
		<div class="nes-container is-rounded with-title status">
			<p class="title">メニュー</p>
			
			<button type="button" class="nes-btn is-primary" onclick="openMenu()">メニュー開く</button>
			<button type="button" class="nes-btn is-primary" onclick="closeMenu()">メニュー閉じる</button>
			
			<div class="nav-menu">
				<div><button type="button" id="menu-btn-5" class="menu-btn nes-btn is-primary" onclick="loadContent(CONTENTS.PUBLISHING)">ゲーム紹介</button></div>
				<div><button type="button" id="menu-btn-4" class="menu-btn nes-btn is-primary" onclick="showGameAsk()">アンケート</button></div>
				<div><button type="button" id="menu-btn-6" class="menu-btn nes-btn is-primary" onclick="showFriends()">トモダチ</button></div>
				<div><button type="button" id="menu-btn-2" class="menu-btn nes-btn is-primary" onclick="loadContent(CONTENTS.HOWTOPLAY)">遊び方</button></div>
				<div><button type="button" id="menu-btn-1" class="menu-btn nes-btn " onclick="loadContent(CONTENTS.MAIN_MENU)">メイン画面</button></div>
				<div><button type="button" id="menu-btn-3" class="menu-btn nes-btn is-primary" onclick="openQRSearch()">ＱＲ探索</button></div>
				<div><button type="button" id="menu-btn-8" class="menu-btn nes-btn is-primary" onclick="showGameHistory()">みんなの冒険の記録</button></div>
				<div><button type="button" id="menu-btn-7" class="menu-btn nes-btn is-primary" onclick="showProfile()">自分のステータス</button></div>
				<div><button type="button" id="menu-btn-9" class="menu-btn nes-btn is-primary" onclick="loadContent(CONTENTS.CREDIT)">権利表記<br />クレジット</button></div>
			</div>
		</div>
	</div>
	
	<!-- <div style="display:none;">
					
		<div class="nes-container with-title status">
			<p class="title">リクエストチェック</p>
			<div class="center">
				<button type="button" id="" class="nes-btn is-primary" onclick="reqCheck('gameStart')";>gamestart</button>
				<div style="height:10px;"></div>
				<button type="button" id="" class="nes-btn is-primary" onclick="reqCheck('gameEnd')";>gameend</button>
				<div style="height:10px;"></div>
			</div>
		</div>
		
		<div style="height:50px;"></div>
		
		<div class="nes-container with-title status">
			<p class="title">メニュー</p>
			<div class="center">
				<button type="button" id="" class="nes-btn is-primary">最新の冒険を見る</button>
				<div style="height:10px;"></div>
				<button type="button" id="" class="nes-btn is-primary">過去の冒険を見る</button>
				<div style="height:10px;"></div>
				<button type="button" id="" class="nes-btn is-primary">冒険者を見る</button>
				<div style="height:10px;"></div>
				<button type="button" id="" class="nes-btn is-primary" onclick="initializePush();">通知登録</button>
				<div style="height:10px;"></div>
				<button type="button" id="" class="nes-btn is-primary" onclick="subscribeUserToPush();">通知送信</button>
				<div style="height:10px;"></div>
			</div>
		</div>
		 -->
					<!--
					<section style="height:120px;">
						<div class="nes-container is-rounded with-title" style="height:80px;">
						<p class="title" style="float: none;">冒険者が魔法を使った</p>
						<p>{Event:1, Value:500}</p>
						</div>
					</section>
					<section class="message -left" style="height:120px;">
						<div style="display:flex;">
							<div class="faceicon">
								<div class="face"></div>
								<div class="nes-badge nameplate" style="width:80px;">
									<span class="is-dark">ああああ</span>
								</div>
							</div>
							<div class="nes-balloon from-left chatmsg" style="height:70px;top:-10px;padding: 5px;">
								<p style="width: 180px;height:60px;overflow: hidden;text-overflow: ellipsis;">Hello NES.cssHello NES.cssHello NES.cssHello NES.css</p>
							</div>
						</div>
					</section>
					<section style="height:120px;">
						<div class="nes-container is-rounded with-title" style="height:80px;">
						<p class="title" style="max-width:240px;">冒険者が魔法を使った</p>
						<p>{Event:1, Value:500}</p>
						</div>
					</section>
					<section style="height:100px;">
						<div class="nes-container is-rounded with-title" style="height:80px;">
						<p class="title" style="float: none;">冒険者が魔法を使った</p>
						<p>{Event:1, Value:500}</p>
						</div>
					</section>
					<section class="message -right" style="height:100px;">
						<div style="display:flex;">
							<div class="nes-balloon from-right chatmsg" style="height:70px;top:-10px;padding: 5px;">
								<p style="width: 180px;height:60px;overflow: hidden;text-overflow: ellipsis;">Hello NES.cssHello NES.cssHello NES.cssHello NES.css</p>
							</div>
							<div class="faceicon">
								<div class="face"></div>
								<div class="nes-badge nameplate" style="width:80px;">
									<span class="is-dark">ああああ</span>
								</div>
							</div>
						</div>
					</section>
					<section style="height:100px;">
						<div class="nes-container is-rounded with-title" style="height:80px;">
						<p class="title" style="float: none;">冒険者が魔法を使った</p>
						<p>{Event:1, Value:500}</p>
						</div>
					</section>
					-->
</section>
</body>
</html>
