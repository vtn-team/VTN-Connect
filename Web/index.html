<html>
<head>
<link rel="manifest" href="/manifest.json" />
<link rel="apple-touch-icon" href="/icon.png"></link>
<meta name="theme-color" content="#fff" />
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0 user-scalable=no">
<title>VANTAN - CONNECT</title>
<style>
/* ドット調のフォントに変更 */
@font-face {
  font-family: "dotfont";
  src: url("/togalite.woff2") format("woff2");
  url("/togalite.woff") format("woff");
}

body {
  font-family: ; "dotfont";
  background-image: url('bg.gif');
  background-size: auto 100vh;
  background-repeat: no-repeat;
  background-attachment: fixed;
}

/* モーダル */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.4);
  z-index: 1;
}

.modal-content {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  padding: 20px;
}

#cheer {
  /*width: 300px;*/
  /*height: 60px;*/
  background-color: #fefefe;
  border: 1px solid #888;
  border-radius: 10px;
}

#closeModal {
  position: absolute;
  display: flex;
  align-items: center;
  justify-content: center;
  top: 2%;
  right: 2%;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  color: #FFF;
  width: 40px;
  height: 40px;
  background-color: #333;
}

/* レイアウト */
.layout {
  width: 100%;

  display: grid;
  grid:
    "header header" auto
    "debugitem main" 1fr
    "footer footer" auto
    / auto 1fr;
  gap: 8px;
}

.header {
  grid-area: header;
  position: sticky;
  top: 0px;
  display: flex;
  align-items: baseline;
  max-width: 375px;
  //margin: 0 auto;
  padding-top: 1rem;
  transition: all 0.2s ease;
  z-index: 10;
}

.status {
  width:375px;
  max-width: 375px;
  margin: 0 auto;
  background-color: #eeeeeeee
}

/* 浮かせるヘッダ */
header.nav {
  font-size: 0.8rem;
  padding: 0;
  align-items: center;
}

header.nav h1 {
  margin: 0;
}

header.nav p {
  display: none;
  margin-bottom: 0;
  font-size: 0.6rem;
}

.important { grid-area: important; }
.main { grid-area: main; }
.debugitem { grid-area: debugitem; }
.footer { grid-area: footer; }
.sidebar {  }
.long { height: 800px; }
.center { text-align:center; margin: 0 auto; }
.right { text-align:right; margin: 0 0 0 auto; }
.face { border-radius: 10px; width: 80px; height: 80px; border: solid 2px #000; background-color: #eee; }
.faceicon { float: right; width: 80px; height: 100px; }
.chatmsg { float: left; width: 200px; }
.nameplate { top:-25px; left:-8px; }

#reader { 
  display:none;
  width: 320px;
}
#userinfo {
  display:none;
}
#qrresult { 
  display:none;
}
#qrscancancel{ 
  display:none;
}
.leftmenu {
  width: 640px;
  max-width: 640px;
  margin: 20 20 auto;
  background-color: #eeeeeeee
}
</style>
<link href="https://unpkg.com/nes.css/css/nes-core.min.css" rel="stylesheet" />
<script src="https://unpkg.com/html5-qrcode" type="text/javascript" ></script>
<script src="anime.min.js"></script>
<script type="text/javascript">

const CMD = {
	WELCOME: 1,
	JOIN: 2,
	EVENT: 3,
	GAMESTAT: 4,
	SEND_JOIN: 100,
	SEND_EVENT: 101,
	SEND_EPISODE: 102,
	SEND_CHEER: 103,
	SEND_USER_JOIN: 110,
};

const PAGE = {
	USER_CREATE: 0,
	MAIN_MENU: 1,
	SUMMON_EFFECT: 2,
}

let userData = {};
let gameInfo = {};
let elementCache = [];
let elementStatus = [];
let currentPageCode = -1;
let callNo = 0;

let ws = null;
let wsSessionId = "";

let qrReader = null;
let baseURI = "https://vc.vtn-game.com";


//サービスワーカーの登録
if ('serviceWorker' in navigator) {
   navigator.serviceWorker.register("/serviceworker.js");
}

window.addEventListener("load", async (event) => {
	console.log("onload event");
	
	//localhostの場合挙動を変える
	if(document.location.hostname == "localhost") {
		baseURI = "http://localhost:4649";
	}
	
	//最終的に埋め込む
	gameInfo = await getMaster("GameInfo");
	
	//PCの場合デバッグメニューだす
	if(document.location.hostname.indexOf("www.vtn-game.com") == -1) {
		enableUIById("debugitem");
		setupDebugMenu();
	}
	
	//animating wallpaper
	var tl = anime.timeline({
		targets: "body",
		direction: 'alternate', // Is not inherited
		easing: 'easeInOutCubic',
		loop: true
	});
	tl.add({
		backgroundPositionX: 100,
		duration: 100000
	})
	.add({
		backgroundPositionX: 0,
		duration: 100000,
	})
	
	//ページコンテンツの分解
	setupSPA();
	
	//debug
	if(0){
		summonEffect();
		userCreateNextPageCheck(1);
		return;
	}
	
	//クッキー取得
	var cookie = getCookieArray();
	if(!cookie.user_hash || cookie.user_hash === "undefined") {
		//初回登録
		loadPage(PAGE.USER_CREATE);
	}else{
		//ログイン
		await loadUser(cookie.user_hash);
		userSetup();
		loadPage(PAGE.MAIN_MENU);
	}
});


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// API 
//////////

//接続先取得
async function getaddr() {
	let req = await fetch(`${baseURI}/vc/getaddr`, {
		mode: 'cors'
	});
	let result = await req.json();
	return result.Address;
}

//マスタ取得
async function getMaster(name) {
	let req = await fetch(`${baseURI}/tools/getmaster/${name}`, {
		mode: 'cors'
	});
	let result = await req.json();
	return result.Master;
}

//ユーザ読み込み
async function loadUser(userHash) {
	let user = localStorage.getItem("UserData");
	if(user) {
		try{
			user = JSON.parse(user);
		}catch(ex){
		}
	}
	
	if(user && user.UserHash) {
		userData = user;
	}else{
		let req = await fetch(`${baseURI}/vc/user/${userHash}`, {
			mode: 'cors'
		});
		let result = await req.json();
		
		userData = result.UserData;
		localStorage.setItem("UserData", JSON.stringify(userData));
	}
}

//ユーザ作成
async function createUser(data) {
	let req = await fetch(`${baseURI}/vc/usercreate`, {
		method: 'POST',
		mode: 'cors',
		body: JSON.stringify(data)
	});
	
	let result = await req.json();
	if(result.Success) {
		saveUserSession(result.UserData.UserHash);
	}
	
	userData = result.UserData;
}

function userSetup() {
	createUserInfoUI();
	enableUIById("userinfo");
	
	connectDGS();
}


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// EVENT 
//////////
//WebSocket接続
async function connectDGS() {
	let addr = await getaddr();
	ws = new WebSocket(addr);
	
	ws.onopen = (event) => {
	};
	
	ws.onerror = (error) => {
		console.log("Connection Error");
		console.log(error)
		getElm("ws-state").innerText = "エラー";
	};
		
	ws.onclose = (event) => {
		console.log("close");
		getElm("ws-state").innerText = "切断";
	};

	ws.onmessage = (event) => {
		const json = JSON.parse(event.data);
		const time = new Date(json.date);
		//場合に応じて
		let data = JSON.parse(json.Data);
		json.Data = data;
		execMessage(json);
	};
}

function execMessage(data) {
	let ret = "";
	switch(data.Command){
	case CMD.WELCOME:
	{
		//SessionIdをキーにしてJoinを返す
		let json = {
			SessionId: data.Data.SessionId,
			Command: CMD.SEND_USER_JOIN,
			UserId: userData.UserId,
		};
		ws.send(JSON.stringify(json));
		wsSessionId = data.Data.SessionId;
		getElm("ws-state").innerText = "接続";
	}
	break;
	
	case CMD.GAMESTAT:
		console.log(data.Data);
		activeGameInfo = data.Data.ActiveGames;
		updateGameStat(data.Data);
		break;
	
	case CMD.EVENT:
	{
		//addSysLog("冒険者が魔法を使った", data.Data.Data);
		switch(data.Data.EventId)
		{
		case 100:
		{
		}
		break;
		
		case 1000:
		{
			addSysLog(data.Data.Data.Name, data.Data.Data.Message);
		}
		break;
		
		case 1001:
		{
			addLog(data.Data);
		}
		break;
		
		case 1002:
		{
			addSysLog(data.Data.Data.Name, data.Data.Data.Message);
		}
		break;
		}
	}
	break;
	
	}
	return ret;
}

function sendCheerMessage(toUserId, tgtGameId) {
	let msg = getElm("msg").value;
	cheerMessage(toUserId, tgtGameId, msg, 0);
}

function cheerMessage(toUserId, tgtGameId, msg, emo) {
	let fromUserId = -1;
	if(userData.UserId) {
		fromUserId = userData.UserId;
	}
	let name = "nanashi";
	if(userData.DisplayName) {
		name = userData.DisplayName;
	}
	
	//SessionIdをキーにしてJoinを返す
	let data = {
		Avatar: userData.AvatarType,
		Name: name,
		Message: msg,
	};
	
	if(emo) {
		data.Emotion = emo;
	}
	
	let json = {
		SessionId: wsSessionId,
		Command: CMD.SEND_CHEER,
		GameId: tgtGameId,
		ToUserId: toUserId,
		FromUserId: fromUserId,
		Data: data
	};
	ws.send(JSON.stringify(json));
}


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// HTML生成回り 
//////////

function setupSPA() {
	elementCache.push(getElm("page-user-create"));
	elementCache.push(getElm("page-main-menu"));
	elementCache.push(getElm("page-summon-effect"));
	
	for(let i=0; i < elementCache.length; ++i) {
		elementStatus.push(0);
	}
	
	getElm("usercreate").addEventListener('click', async () => {
		let data = {
			Name: getElm("username").value,
			Questions: [
				getElm("question1").value,
				getElm("question2").value,
				getElm("question3").value,
				getElm("question4").value,
			]
		};
		console.log(data);
	
		summonEffect();
		await createUser(data);
		userCreateNextPageCheck(1);
	});
}

function loadPage(pageCode) {
	if(currentPageCode == pageCode) return;
	
	var elm = getElm("main");
	
	for(let i=0; i < elementStatus.length; ++i) {
		if(elementStatus[i]) {
			elementCache[i].style.display = "none";
			elementStatus[i] = 0;
		}
	}
	
	elementCache[pageCode].style.display = "block";
	elementStatus[pageCode] = 1;
	
	currentPageCode = pageCode;
}

function summonEffect() {
	loadPage(PAGE.SUMMON_EFFECT);
	
	anime({
		targets: getElm("summongauge"),
		value: [0, 150],
		easing: 'easeInOutQuart',
			round: 1,
			duration: 10000,
			easing: 'easeInOutExpo'
	});
	
	setTimeout(() => {
		userCreateNextPageCheck(2);
	}, 7500);
}

function userCreateNextPageCheck(no) {
console.log("no:" + no)
	callNo += no;
	if(callNo >= 3) {
		userSetup();
		loadPage(PAGE.MAIN_MENU);
	}
}

function addSysLog(evtName, evtMessage) {
	var log=`
					<section style="height:120px;">
						<div class="nes-container is-rounded with-title" style="height:80px;">
						<p class="title">${evtName}</p>
						<p style="overflow: hidden;text-overflow: ellipsis;">${evtMessage}</p>
						</div>
					</section>
`;
	var elm = getElm("msglog");
	elm.innerHTML += log;
	while(elm.children.length > 10)
	{
		elm.children[0].remove();
	}
}

function addLog(evtData) {
	let isSelf = wsSessionId == evtData.SessionId
	let name = evtData.Data.Name;
	let text = evtData.Data.Message;
	let emo = evtData.Data.Emotion;
	var left=`
					<section class="message -left" style="height:120px;">
						<div style="display:flex;">
							<div class="faceicon">
								<div class="face">${emo}</div>
								<div class="nes-badge nameplate" style="width:80px;">
									<span class="is-dark">${name}</span>
								</div>
							</div>
							<div class="nes-balloon from-left chatmsg" style="height:70px;top:-10px;padding: 5px;">
								<p style="width: 180px;height:60px;overflow: hidden;text-overflow: ellipsis;">${text}</p>
							</div>
						</div>
					</section>
`;
	var right=`
					<section class="message -right" style="height:120px;">
						<div style="display:flex;">
							<div class="nes-balloon from-right chatmsg" style="height:70px;top:-10px;padding: 5px;">
								<p style="width: 180px;height:60px;overflow: hidden;text-overflow: ellipsis;">${text}</p>
							</div>
							<div class="faceicon">
								<div class="face">${emo}</div>
								<div class="nes-badge nameplate" style="width:80px;">
									<span class="is-dark">${name}</span>
								</div>
							</div>
						</div>
					</section>
`;
	var elm = getElm("msglog");
	elm.innerHTML += isSelf ? right : left;
	while(elm.children.length > 10)
	{
		elm.children[0].remove();
	}
}


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// QR 
//////////

function setupQRHtml() {
	var html=`
		<div class="nes-container with-title status">
			<p class="title">QR読み込み</p>
			<div class="center">
				<button type="button" id="qrscan" class="nes-btn is-primary" onclick="readQR();">読み込み</button><br /><br />
				<button type="button" id="qrscancancel" class="nes-btn is-primary" onclick="cencelQR();">キャンセル</button>
				<div id="reader"></div>
				<div id="qrresult">読み込み結果</div>
			</div>
		</div>
	`;
	
	var elm = getElm("important");
	elm.innerHTML += html;
}

async function readQR() {
	disableUIById("qrscancancel");
	enableUIById("qrscancancel");
	enableUIById("reader");
	
	let devices = await Html5Qrcode.getCameras();
	console.log(devices)
	let cameraId = devices[0].id;
	if(devices[1]) {
		cameraId = devices[1].id;
	}
	
	qrReader = new Html5Qrcode("reader");
	qrReader.start(
		cameraId, 
	{
		fps: 10,	// Optional, frame per seconds for qr code scanning
		qrbox: { width: 250, height: 250 }  // Optional, if you want bounded box UI
	},
	onScanSuccess,
	(errorMessage) => {
		// parse error, ignore it.
		console.log(errorMessage)
	})
	.catch((err) => {
		// Start failed, handle it.
		console.log(err)
	});
}

async function cencelQR() {
	disableUIById("qrscancancel");
	disableUIById("qrresult");
	enableUIById("qrscancancel");
	
	if(!qrReader) return;
	await qrReader.stop();
	
	disableUIById("reader");
}

async function onScanSuccess(decodedText, decodedResult) {
    // Handle on success condition with the decoded text or result.
	enableUIById("qrresult");
	await qrReader.stop();
	
	if(!userData || !userData.UserId)
	{
		getElm("qrresult").innerText = "ユーザー登録されていません";
		return;
	}
	
	if(decodedText.indexOf("VantanConnectQR:") == -1) {
		getElm("qrresult").innerText = "無効なQRです";
		return;
	}
	
	decodedText = decodedText.replace("VantanConnectQR:","");
	
	try{
		
		let data = JSON.parse(decodedText);
		
		//SessionIdをキーにしてJoinを返す
		let json = {
			SessionId: wsSessionId,
			Command: CMD.SEND_EVENT,
			EventId: data.EventId,
			Payload: [{
				Key: "GameId",
				TypeName: "Integer",
				Data: data.GameID
			},
			{
				Key: "UserId",
				TypeName: "Integer",
				Data: userData.UserId
			}]
		};
		ws.send(JSON.stringify(json));
		
	}catch(ex){
		console.log(ex);
	}
}


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// SYSTEM 
//////////

// 連想配列に格納
function getCookieArray() {
    var arr = {};
    if(document.cookie != ''){
        var tmp = document.cookie.split('; ');
        for(var i=0;i<tmp.length;i++){
            var data = tmp[i].split('=');
            arr[data[0]] = decodeURIComponent(data[1]);
        }
    }
    return arr;
}

//クッキーにユーザハッシュを保存
function saveUserSession(userHash) {
	var limit = 7; //Cookieの期限
	var now = new Date(); //現在の日付
	now.setTime(now.getTime() + limit*24*60*60*1000);
	var expireDate = now.toGMTString(); //GMT形式に変換
	
	var cookievalue = "user_hash=" + userHash +";";
	var expires = "expires=" + expireDate + "; ";
	var path = "path=/";
	
	document.cookie = cookievalue + expires + path;
}

function getElm(elmId) {
	return document.getElementById(elmId);
}

function enableUIById(elmId) {
	let elm = getElm(elmId);
	elm.style.display = "block";
}

function disableUIById(elmId) {
	let elm = getElm(elmId);
	elm.style.display = "none";
}

function createdPayload(data) {
	let payload = [];
	if(data) {
		for(var k in data) {
			payload.push({
				Key: k,
				TypeName: typeof data[k],
				Data: data[k]
			});
		}
	}
	return payload;
}

function updateGameStat(data) {
	var html="";
	
	for(let game of data.ActiveGames) {
		let plusOn = "";
		let active = "ゲーム台は空いています";
		if(game.GameId == 1) {
			active = "冒険の準備中";
		}else{
			if(game.ActiveTime == 0) {
				active = "メンテナンス中…";
			}
		}
		if(game.Session && game.Session.Status == 1 && game.Session.UserId) {
			active = "プレイ中！";
			plusOn = `<button type="button" id="cheer${game.GameId}" class="nes-btn is-primary" onclick="cheerAct(${game.GameId}, ${game.Session.UserId})">応援する！</button>`;
		}
		
		
		html += `
		<div class="nes-container with-title">
			<p class="title">${game.Title}</p>
			<div>${active}</div>
			${plusOn}
		</div>
		<div style="height:10px;"></div>
`;
	}
	
	getElm("gamelist").innerHTML = html;
	getElm("ws-state").innerHTML = "接続中のユーザ:" + data.ActiveUsers.length + "人";
}

function createUserInfoUI() {
	getElm("fullname").innerText = userData.Name;
	getElm("level").innerText = userData.Level;
	getElm("gender").innerText = userData.Gender;
	getElm("age").innerText = userData.Age;
	getElm("job").innerText = userData.Job;
	getElm("personality").innerText = userData.Personality;
	getElm("motivation").innerText = userData.Motivation;
	getElm("weakness").innerText = userData.Weaknesses;
	getElm("backstory").innerText = userData.Background;
	
	getElm("dbgUserId").innerText = userData.UserId;
	getElm("dbgAvatarType").innerText = userData.AvatarType;
}


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// DEBUG 
//////////

let myGameId = -1;
let gameIngo = {};
let gameEvent = {};
async function setupDebugMenu() {
	gameEvent = await getMaster("GameEvent");
	
	let elm = getElm("dbgSelector");
	for(let game of gameInfo) {
		var option = document.createElement("option");
		option.text = game.GameTitle;
		option.value = game.Id;
		elm.appendChild(option);
	}
	
	elm.addEventListener("change", (event)=>{
		let elm = getElm("dbgSelector");
		filterAndShowDebugEvent(elm.value);
		localStorage.setItem("myGame", elm.value);
		myGameId = parseInt(elm.value);
	});
	
	const myGame = localStorage.getItem("myGame");
	console.log("here:" + myGame);
	if(myGame) {
		elm.selectedIndex = myGame;
		filterAndShowDebugEvent(myGame);
		myGameId = parseInt(myGame);
	}
}

function goodCheer() {
	cheerMessage(userData.UserId, myGameId, "がんばれ", 50);
}

function badCheer() {
	cheerMessage(userData.UserId, myGameId, "くたばれ", -50);
}

function filterAndShowDebugEvent(gameId) {
	let elm = getElm("eventDebug");
	let html = "";
	for(let evt of gameEvent) {
		if(evt.Release == "") continue;
		if(evt.Target == -1 || evt.Target == gameId) {
			html += `<button type="button" class="nes-btn is-primary" onclick=sendTestEvent(${evt.Id})>${evt.Description}</button><div style="height:10px;"></div>`;
		}
	}
	elm.innerHTML = html;
	enableUIById("cheerDebug");
}

function reCreateUser() {
	loadPage(PAGE.USER_CREATE);
}

async function sendTestEvent(evtId) {
	let json = {
		SessionId: wsSessionId,
		Command: CMD.SEND_EVENT,
		GameId: myGameId,
		EventId: evtId,
		Payload: []
	};
	ws.send(JSON.stringify(json));
}
let debugData = {};
async function reqCheck(reqKey) {
	let host = "http://localhost:4649"; //"https://vc.vtn-game.com";
	switch(reqKey) {
	case "gameStart":
	{
		let req = await fetch(host + "/vc/gamestart", {
			mode: 'cors'
		});
		let result = await req.json();
		console.log(result);
		debugData.gameStart = result;
	}
	break;
	
	case "gameEnd":
	{
		let sample = {
			GameHash: "",
			UserResults: [
				{
					UserId: 1,
					GameResult: true,   //脱出
					MissionClear: true, //ミッション成功
				},
				{
					UserId: 35,
					GameResult: false,  //志望
					MissionClear: false,//ミッション失敗
				},
				{
					UserId: 40,
					GameResult: true,   //脱出
					MissionClear: false,//ミッション失敗
				},
				{
					UserId: 42,
					GameResult: false,  //脱出
					MissionClear: true, //ミッション成功
				}
			]
		};
		
		let req = await fetch(host + "/vc/gamestart", {
			mode: 'cors',
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify(sample)
		});
		let result = await req.json();
		console.log(result);
		debugData.gameStart = result;
	}
	break;
	}
}


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// 通知
//////////
function notifyMe() {
	if (!("Notification" in window)) {
		// ブラウザーが通知に対応しているか調べる
		alert("このブラウザーはデスクトップ通知に対応していません。");
	} else if (Notification.permission === "granted") {
		// 通知権限が既に付与されているかどうかを調べる。
		// そうであれば、通知を作成
		const notification = new Notification("こんにちは！");
	} else if (Notification.permission !== "denied") {
		// ユーザーにその権限を要求する必要がある
		Notification.requestPermission().then((permission) => {
			// ユーザーが許可したら、通知を作成
			if (permission === "granted") {
				const notification = new Notification("こんにちは！");
			}
		});
	}
	
	//SessionIdをキーにしてJoinを返す
	let json = {
		SessionId: wsSessionId,
		Command: CMD.SEND_EVENT,
		EventId: 1000,
		Payload: [{
			Key: "GameId",
			TypeName: "Integer",
			Data: "2",
		}]
	};
	ws.send(JSON.stringify(json));
}

</script>
</head>
<body>
<section class="layout">
	<div class="header">
	<h1 class="nes-balloon from-left nes-pointer">冒険者たちの集会場</h1>
	<button type="button" id=""class="nes-btn is-primary" onclick="window.location.reload();">更新</button>
	</div>
	
	<div id="modal-connects" class="modal">
		<div class="nes-container with-title status">
			<p class="title">ツウシンジョウタイ</p>
			<div id="ws-state" class="center">未接続</div>
		</div>
	</div>
	
	<div id="modal-cheer" class="modal">
		<div class="modal-content">
			<div id="cheer" class="nes-container with-title status">
				<p class="title">オウエン</p>
				
				<div id="cheerMsg">
				○○サンにメッセージを届けよう！<br /><br />
				書いたメッセージの内容に応じて、良い事や悪いことが起きるぞ。
				</div>
				<br /><br />
				
				<div class="nes-field">
					<label for="name_field">オウエン</label>
					<input type="text" id="msg" class="nes-input">
				</div>
				<div style="height:10px;"></div>
				<div class="right">
					<button type="button" id="test" class="nes-btn is-primary" onclick="testEvent();">ソウシン</button>
				</div>
			</div>
			
			<div id="closeModal" onclick=disableUIById("modal-cheer")>&times;</div>
		</div>
	</div>
	
	<div class="main">
		
		<div id="page-main-menu" style="display:none;">
			<div id ="gameinfo" class="nes-container with-title status">
				<p class="title">ゲーム稼働状況</p>
				
				<div id="gamelist">確認中…</div>
			</div>
			
			<div style="height:50px;"></div>
			
			<div id="main-api-effect" class="nes-container status" style="display:none;">
				<p>通信中！！</p>
				<progress class="nes-progress is-primary" id="mainworkgauge" value="0" max="100"></progress>
			</div>
			
			<div id ="mainmenu" class="nes-container with-title status">
				<p class="title">キロク</p>
				
				<div class="center">
					<button type="button" id="history" class="nes-btn is-primary" onclick="showHistory()">冒険の記録を見る</button>
					<div style="height:25px;"></div>
					<button type="button" id="friend" class="nes-btn is-primary" onclick="showHistory()">出会いの記録</button>
					<div style="height:10px;"></div>
				</div>
			</div>
			
			<div style="height:50px;"></div>
			
			<div class="nes-container with-title status">
				<p class="title">ログ</p>
				<div class="nes-field">
					<section id="msglog" class="message-list">
					</section>
					<div style="height:50px;"></div>
				</div>
			</div>
			
			<div style="height:50px;"></div>
			
			<div id ="userinfo" class="nes-container with-title status">
				<p class="title">あなたのステータス</p>
				
				<div class="nes-container with-title">
					<p class="title">名前</p>
					<div id="fullname"></div>
				</div>
				
				<div style="height:25px;"></div>
				
				<div class="nes-table-responsive">
					<table class="nes-table is-bordered is-centered">
					<tbody>
						<tr>
							<td>レベル</td>
							<td id="level"></td>
						</tr>
						<tr>
							<td>性別</td>
							<td id="gender"></td>
						</tr>
						<tr>
							<td>年齢</td>
							<td id="age"></td>
						</tr>
						<tr>
							<td>職業</td>
							<td id="job"></td>
						</tr>
					</tbody>
					</table>
					
					<div style="height:10px;"></div>
					
					<div class="nes-container with-title">
						<p class="title">個性</p>
						<div id="personality"></div>
					</div>
					
					<div style="height:10px;"></div>
					
					<div class="nes-container with-title">
						<p class="title">やる気</p>
						<div id="motivation"></div>
					</div>
					
					<div style="height:10px;"></div>
					
					<div class="nes-container with-title">
						<p class="title">弱点</p>
						<div id="weakness"></div>
					</div>
					
					<div style="height:10px;"></div>
					
					<div class="nes-container with-title">
						<p class="title">バックストーリー</p>
						<div id="backstory"></div>
					</div>
				</div>
			</div>
			
			<div style="height:50px;"></div>
		</div>
		
		<div id="page-cheer" style="display:none;">
			<div class="nes-container with-title status">
				<p class="title">オウエン</p>
				<div class="nes-field">
					<label for="name_field">オウエン</label>
					<input type="text" id="msg" class="nes-input">
				</div>
				<div style="height:10px;"></div>
				<div class="right">
					<button type="button" id="test" class="nes-btn is-primary" onclick="testEvent();">ソウシン</button>
				</div>
			</div>
		</div>
		
		<div id="page-user-create" class="nes-container with-title status" style="display:none;">
			<p class="title">冒険の書を作る</p>
			
			<br />
			これから会場に自分の分身を『召喚』します<br />
			<br />
			<br />
			
			<div class="nes-container with-title">
				<p class="title">名前</p>
				
				<div class="nes-field">
					<input type="text" id="username" class="nes-input">
					<br />
					<b>※ゲーム環境で公開されます。</b><br />
					本名は避けてもらえると助かります。<br /><br />
					※記載がない場合はAIが勝手に命名します。<br />
					<br />
					長さに応じて愛称または本名が自動生成されます。<br />
				</div>
			</div>
			
			<br />
			いくつか質問をします。<br />
			<br />
			<br />
			
			<div class="nes-container with-title">
				<p class="title">質問1: 召喚先</p>
				
				召喚したキャラはどのような環境で成長しますか？<br />
				<br />
				
				<div class="nes-select is-success">
					<select required id="question1">
					<option value="0" disabled selected hidden>選択しましょう...</option>
					<option value="1">貴族の屋敷</option>
					<option value="2">馬小屋</option>
					<option value="3">一般家庭</option>
					<option value="4">山中(野生児化)</option>
					</select>
				</div>
			</div>
			
			<div style="height:20px;"></div>
			
			<div class="nes-container with-title">
				<p class="title">質問2: 成し遂げたいこと</p>
				
				召喚したキャラが冒険で目指すこと。<br />
				<br />
				
				<div class="nes-select is-warning">
					<select required id="question2">
					<option value="0" disabled selected hidden>選択しましょう...</option>
					<option value="1">お宝見つけて一攫千金を狙う</option>
					<option value="2">最強のプレイヤーになる</option>
					<option value="3">安全に細々と暮らす</option>
					<option value="4">ワンワン！！ ワオーン！！</option>
					</select>
				</div>
			</div>
			
			<div style="height:20px;"></div>
			
			<div class="nes-container with-title">
				<p class="title">質問3: 弱点</p>
				
				召喚キャラの弱点を選んでください<br />
				<br />
				
				<div class="nes-select is-error">
					<select required id="question3">
					<option value="0" disabled selected hidden>選択しましょう...</option>
					<option value="1">無謀である</option>
					<option value="2">承認欲求が強い</option>
					<option value="3">飽きっぽい</option>
					<option value="4">ワンワン！！ ワオーン！！</option>
					</select>
				</div>
			</div>
			
			<div style="height:20px;"></div>
			
			<div class="nes-container with-title">
				<p class="title">質問4: アドバイス</p>
				
				<label for="error_select">召喚キャラにアドバイスしましょう</label>
				<div class="nes-select is-normal">
					<select required id="question4">
					<option value="0" disabled selected hidden>選択しましょう...</option>
					<option value="1">安全に頑張りましょう</option>
					<option value="2">命懸けの冒険をしよう</option>
					<option value="3">友達たくさん作ってね</option>
					<option value="4">ワンワン！！ ワオーン！！</option>
					</select>
				</div>
			</div>
			
			<div style="height:35px;"></div>
			
			<div class="center">
				<button type="button" id="usercreate" class="nes-btn is-primary">召喚する！！</button>
			</div>
		</div>
		
		<div id="page-summon-effect" class="nes-container status" style="display:none;">
			<p>召喚中！！</p>
			<progress class="nes-progress is-primary" id="summongauge" value="0" max="100"></progress>
		</div>
		
		<div style="height:50px;"></div>
	</div>
	
	<div id="debugitem" style="display:none;">
		
					<!--
		<div class="nes-container with-title status">
			<p class="title">リクエストチェック</p>
			<div class="center">
				<button type="button" id="" class="nes-btn is-primary" onclick=reqCheck("gameStart");>gamestart</button>
				<div style="height:10px;"></div>
				<button type="button" id="" class="nes-btn is-primary" onclick=reqCheck("gameEnd");>gameend</button>
				<div style="height:10px;"></div>
			</div>
		</div>
		
		<div style="height:50px;"></div>
		
		<div class="nes-container with-title status">
			<p class="title">メニュー</p>
			<div class="center">
				<button type="button" id="" class="nes-btn is-primary">最新の冒険を見る</button>
				<div style="height:10px;"></div>
				<button type="button" id="" class="nes-btn is-primary">過去の冒険を見る</button>
				<div style="height:10px;"></div>
				<button type="button" id="" class="nes-btn is-primary">冒険者を見る</button>
				<div style="height:10px;"></div>
				<button type="button" id="" class="nes-btn is-primary" onclick="notifyMe();">通知</button>
			</div>
		</div>
		-->
		
		<div class="nes-container with-title leftmenu">
			<p class="title">デバッグメニュー</p>
			
			<div class="nes-container with-title">
				<p class="title">機能テスト</p>
				
				<div style="height:10px;"></div>
				<button type="button" class="nes-btn is-primary" onclick="notifyMe();">通知</button>
				
				<div style="height:10px;"></div>
				<button type="button" class="nes-btn is-primary" onclick="reCreateUser();">ユーザ登録やり直す</button>
				NOTE: 作り直すまでデータは消えない<br />
			</div>
			
			<div style="height:50px;"></div>
			
			<div class="nes-container with-title">
				<p class="title">ユーザパラメータ</p>
				
				<table class="nes-table is-bordered is-centered">
				<tbody>
					<tr>
						<td>UserId</td>
						<td id="dbgUserId"></td>
					</tr>
					<tr>
						<td>AvatarType</td>
						<td id="dbgAvatarType"></td>
					</tr>
				</tbody>
				</table>
				<button type="button" class="nes-btn is-primary" onclick="levelUp();">レベルアップ</button>
			</div>

			<div style="height:50px;"></div>
			
			<div class="nes-container with-title">
				<p class="title">テストイベント</p>
				
				<div id="cheerDebug" style="display:none;">
					NOTE: Emotionはそれぞれ50)<br />
					<button type="button" class="nes-btn is-primary" onclick=goodCheer()>よい応援</button><div style="height:10px;"></div>
					<button type="button" class="nes-btn is-primary" onclick=badCheer()>わるい応援</button><div style="height:10px;"></div>
				</div>
				
				<div style="height:20px;"></div>
				
				<label for="error_select">イベントを送信するデバッグ対象のゲーム</label>
				<div id="dbgEvent" class="nes-select is-normal">
					<select required id="dbgSelector">
					<option value="0" disabled selected hidden>選択しましょう...</option>
					</select>
				</div>
				
				<div style="height:20px;"></div>
				
				<div id="eventDebug"></div>
				
				<div style="height:20px;"></div>
				
				<div id="debugNote">
					NOTE: 会場イベントは連投できない(ゲームに飛ぶのは10秒に1回のみ)<br />
					NOTE: アーティファクト出現イベントは、一回の冒険中に1度しか出ない<br />
				</div>
				<div style="height:50px;"></div>
			</div>
		</div>
		
					<!--
					<section style="height:120px;">
						<div class="nes-container is-rounded with-title" style="height:80px;">
						<p class="title" style="float: none;">冒険者が魔法を使った</p>
						<p>{Event:1, Value:500}</p>
						</div>
					</section>
					<section class="message -left" style="height:120px;">
						<div style="display:flex;">
							<div class="faceicon">
								<div class="face"></div>
								<div class="nes-badge nameplate" style="width:80px;">
									<span class="is-dark">ああああ</span>
								</div>
							</div>
							<div class="nes-balloon from-left chatmsg" style="height:70px;top:-10px;padding: 5px;">
								<p style="width: 180px;height:60px;overflow: hidden;text-overflow: ellipsis;">Hello NES.cssHello NES.cssHello NES.cssHello NES.css</p>
							</div>
						</div>
					</section>
					<section style="height:120px;">
						<div class="nes-container is-rounded with-title" style="height:80px;">
						<p class="title" style="max-width:240px;">冒険者が魔法を使った</p>
						<p>{Event:1, Value:500}</p>
						</div>
					</section>
					<section style="height:100px;">
						<div class="nes-container is-rounded with-title" style="height:80px;">
						<p class="title" style="float: none;">冒険者が魔法を使った</p>
						<p>{Event:1, Value:500}</p>
						</div>
					</section>
					<section class="message -right" style="height:100px;">
						<div style="display:flex;">
							<div class="nes-balloon from-right chatmsg" style="height:70px;top:-10px;padding: 5px;">
								<p style="width: 180px;height:60px;overflow: hidden;text-overflow: ellipsis;">Hello NES.cssHello NES.cssHello NES.cssHello NES.css</p>
							</div>
							<div class="faceicon">
								<div class="face"></div>
								<div class="nes-badge nameplate" style="width:80px;">
									<span class="is-dark">ああああ</span>
								</div>
							</div>
						</div>
					</section>
					<section style="height:100px;">
						<div class="nes-container is-rounded with-title" style="height:80px;">
						<p class="title" style="float: none;">冒険者が魔法を使った</p>
						<p>{Event:1, Value:500}</p>
						</div>
					</section>
					-->
	<div>
	
	<div class="footer">
	</div>
</section>
<div class="sidebar">1</div>
</body>
</html>
