<html>
<head>
<style>
.layout {
  width: 100%;

  display: grid;
  grid:
    "header" auto
    "main" 1fr
    "footer" auto
    / 1fr;
  gap: 8px;
}

.header {
  position: sticky;
  top: 0px;
  display: flex;
  align-items: baseline;
  max-width: 980px;
  //margin: 0 auto;
  padding-top: 1rem;
  transition: all 0.2s ease;
}

.status {
	width:320px;
	max-width: 980px;
	margin: 0 auto;
}

/* Header-sticky */
header.nav {
  font-size: 0.8rem;
  padding: 0;
  align-items: center;
}
header.nav h1 {
  margin: 0;
}
header.nav p {
  display: none;
  margin-bottom: 0;
  font-size: 0.6rem;
}

.main { grid-area: main; }
.footer { grid-area: footer; }
.sidebar {  }
.long { height: 800px; }
#reader { display:none; }
#usercreate { display:none; }
</style>
<link href="https://unpkg.com/nes.css/css/nes-core.min.css" rel="stylesheet" />
<script src="https://unpkg.com/html5-qrcode" type="text/javascript" ></script>
<script type="text/javascript">

const CMD = {
	WELCOME: 1,
	JOIN: 2,
	EVENT: 3,
	SEND_JOIN: 100,
	SEND_EVENT: 101,
};

let userData = {};
let ws = null;
window.addEventListener("load", (event) => {
	console.log("ページが完全に読み込まれました");

	var cookie = getCookieArray();
	console.log(cookie)

	//セットアップ
	var html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
	html5QrcodeScanner.render(onScanSuccess);
	getElm("usercreate").addEventListener('click', () => {
		disableUIById("usercreate");
		createUser();
	});
	
	connectDGS("wss:/d2yxx4bel49ygi.cloudfront.net");
	
	/*
	if(!cookie.user_hash || cookie.user_hash === "undefined") {
		enableUIById("usercreate");
	}else{
		loadUser(cookie.user_hash);
	}
	*/
	debugLoad();
	createUserInfoUI();
});

function onScanSuccess(decodedText, decodedResult) {
    // Handle on success condition with the decoded text or result.
    console.log(`Scan result: ${decodedText}`, decodedResult);
}

//接続先取得
async function getaddr() {
	let req = await fetch("https://vc.vtn-game.com/vc/getaddr", {
		mode: 'cors'
	});
	let result = await req.json();
	console.log(result);
	return result.address;
}

function execMessage(data) {
	console.log(data);
	
	let ret = "";
	switch(data.Command){
	case CMD.WELCOME:
	{
		//SessionIdをキーにしてJoinを返す
		let json = {
			SessionId: data.Data.SessionId,
			Command: CMD.SEND_JOIN,
			GameId: 1,
		};
		ws.send(JSON.stringify(json));
	}
	break;
	
	case CMD.EVENT:
	{
		
	}
	break;
	
	}
	return ret;
}

//WebSocket接続
async function connectDGS(addr) {
	ws = new WebSocket(addr);
	
	ws.onopen = (event) => {
	};
	
	ws.onerror = (error) => {
		console.log("Connection Error: " + error.toString());
	};
		
	ws.onclose = (event) => {
		console.log("close");
	};

	ws.onmessage = (event) => {
		const json = JSON.parse(event.data);
		const time = new Date(json.date);
		//場合に応じて
		let data = JSON.parse(json.Data);
		json.Data = data;
		execMessage(json);
	};
}

function debugLoad() {
	userData = {
		"userId": 1058,
		"userHash": "e74a75f4-78b1-4d91-8b72-e83946cc21ae",
		"Type": 1,
		"Level": 1,
		"Gold": 500,
		"FullName": "ルフィ・D・エース",
		"DisplayName": "モンキー・D・ルフィ",
		"Gender": "男性",
		"Age": 19,
		"Job": "海賊",
		"Personality": "活発で無邪気だが、仲間思いで責任感が強い",
		"Motivation": "海賊王になるため、仲間と共に冒険すること",
		"Weaknesses": "熱い感情に流されやすく、戦略的思考に欠ける",
		"Background": "東の海出身で、ゴムゴムの実を食べて超人間の能力を得た。仲間と共に冒険し、様々な敵と戦いながら成長している。"
	};
}

//ユーザ読み込み
async function loadUser(userHash) {
	let req = await fetch("https://vc.vtn-game.com/vc/user/" + userHash, {
		mode: 'cors'
	});
	console.log(req);
	let result = await req.json();
	console.log(result);
	
	userData = result.result;
}

//ユーザ作成
async function createUser() {
	let req = await fetch("https://vc.vtn-game.com/vc/usercreate", {
		mode: 'cors'
	});
	console.log(req);
	let result = await req.json();
	console.log(result);
	if(result.success) {
		saveUserSession(result.result.userHash);
	}
	userData = result.result;
}

// 連想配列に格納
function getCookieArray() {
    var arr = {};
    if(document.cookie != ''){
        var tmp = document.cookie.split('; ');
        for(var i=0;i<tmp.length;i++){
            var data = tmp[i].split('=');
            arr[data[0]] = decodeURIComponent(data[1]);
        }
    }
    return arr;
}

//クッキーにユーザハッシュを保存
function saveUserSession(userHash) {
	var limit = 7; //Cookieの期限
	var now = new Date(); //現在の日付
	now.setTime(now.getTime() + limit*24*60*60*1000);
	var expireDate = now.toGMTString(); //GMT形式に変換
	
	var cookievalue = "user_hash=" + userHash +";";
	var expires = "expires=" + expireDate + "; ";
	var path = "path=/";
	
	document.cookie = cookievalue + expires + path;
}

function getElm(elmId) {
	return document.getElementById(elmId);
}

function enableUIById(elmId) {
	let elm = getElm(elmId);
	elm.style.display = "block";
}

function disableUIById(elmId) {
	let elm = getElm(elmId);
	elm.style.display = "none";
}

function createUserInfoUI() {
	getElm("level").innerText = userData.Level;
	getElm("gender").innerText = userData.Gender;
	getElm("age").innerText = userData.Age;
	getElm("job").innerText = userData.Job;
}

</script>
</head>
<body>
<section class="layout">
	<div class="header">
	<h1 class="nes-balloon from-left nes-pointer">冒険者たちの集会場</h1>
	</div>
	<div class="main">
		<button type="button" id="usercreate" class="nes-btn is-primary" onclick=”javascript:createUser();”>冒険者登録</button>
		<div class="nes-container with-title status">
			<p class="title">あなたのステータス</p>
			<div class="nes-table-responsive">
				<table class="nes-table is-bordered is-centered">
				<tbody>
					<tr>
						<td>レベル</td>
						<td id="level"></td>
					</tr>
					<tr>
						<td>性別</td>
						<td id="gender"></td>
					</tr>
					<tr>
						<td>年齢</td>
						<td id="age"></td>
					</tr>
					<tr>
						<td>職業</td>
						<td id="job"></td>
					</tr>
				</tbody>
				</table>
			</div>
		</div>
	</div>
	
	<div style="width: 500px" id="reader"></div>
	</div>
	<div class="footer">
	</div>
	<div class="long">
	</div>
	<div class="long">
	</div>
	<div class="long">
	</div>
</section>
<div class="sidebar">1</div>
</body>
</html>
